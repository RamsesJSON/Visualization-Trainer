<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VisuTrain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #14141f;
            --bg-elevated: #1c1c2a;
            --accent: #8b5cf6;
            --accent-glow: rgba(139, 92, 246, 0.4);
            --accent-secondary: #06d6a0;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --danger: #ef4444;
            --radius: 16px;
            --radius-sm: 10px;
            --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --nav-height: 72px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: 'Inter', sans-serif;
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* ========== MAIN APP ========== */
        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* ========== VIEWS CONTAINER ========== */
        .views {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 24px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: opacity var(--transition), transform var(--transition), visibility var(--transition);
        }

        .view.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* ========== BOTTOM NAV ========== */
        .nav {
            height: var(--nav-height);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .nav-btn {
            flex: 1;
            max-width: 140px;
            height: 52px;
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .nav-btn .icon {
            font-size: 1.4rem;
        }

        .nav-btn:hover {
            color: var(--text-dim);
            background: var(--bg-elevated);
        }

        .nav-btn.active {
            color: var(--accent);
            background: rgba(139, 92, 246, 0.12);
        }

        /* ========== TRAIN VIEW ========== */
        .train-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 32px;
        }

        .train-empty {
            max-width: 360px;
        }

        .train-empty-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--accent) 0%, #06d6a0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin: 0 auto 24px;
            animation: pulse-glow 3s ease-in-out infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 30px var(--accent-glow);
            }

            50% {
                box-shadow: 0 0 60px var(--accent-glow), 0 0 90px rgba(6, 214, 160, 0.2);
            }
        }

        .train-empty h2 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .train-empty p {
            color: var(--text-dim);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .train-empty-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background: var(--accent);
            border: none;
            border-radius: 50px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
        }

        .train-empty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px var(--accent-glow);
        }

        /* Training Active State */
        .train-active {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .train-active.visible {
            display: flex;
        }

        .train-empty.hidden {
            display: none;
        }

        .train-image-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            min-height: 0;
        }

        .train-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--radius);
            transition: transform var(--transition);
        }

        .train-image-wrap:hover .train-image {
            transform: scale(1.02);
        }

        .train-tap-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            color: var(--text-dim);
            border: 1px solid var(--border);
            pointer-events: none;
            opacity: 0.8;
        }

        .train-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius);
            margin-top: 20px;
        }

        .train-stat {
            text-align: center;
        }

        .train-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .train-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }

        /* ========== GALLERY VIEW ========== */
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .gallery-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .gallery-count {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px;
        }

        .gallery-card {
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: all var(--transition);
            border: 2px solid transparent;
        }

        .gallery-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .gallery-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        .gallery-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, transparent 50%);
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .gallery-card:hover .gallery-card-overlay,
        .gallery-card.selected .gallery-card-overlay {
            opacity: 1;
        }

        .gallery-card-best {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-secondary);
        }

        .gallery-card-sessions {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .gallery-card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            opacity: 0;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-card:hover .gallery-card-delete {
            opacity: 1;
        }

        .gallery-card-delete:hover {
            background: var(--danger);
            color: white;
        }

        /* Add Card */
        .gallery-add {
            aspect-ratio: 1;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--text-muted);
        }

        .gallery-add:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(139, 92, 246, 0.05);
        }

        .gallery-add-icon {
            font-size: 2rem;
        }

        .gallery-add-text {
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* ========== STATS VIEW ========== */
        .stats-header {
            margin-bottom: 24px;
        }

        .stats-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stats-header p {
            color: var(--text-muted);
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
        }

        .stat-card-value {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .history-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .history-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .history-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .history-filters select,
        .history-filters input,
        .history-filters button {
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 0.8rem;
            font-family: inherit;
        }

        .history-filters button {
            cursor: pointer;
            transition: background var(--transition);
        }

        .history-filters button:hover {
            background: var(--accent);
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
            transition: background var(--transition);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: var(--bg-elevated);
        }

        .history-item-time {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-secondary);
            min-width: 80px;
        }

        .history-item-date {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .history-item-note {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition);
        }

        .history-item-delete:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .history-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        .history-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 12px;
            border-top: 1px solid var(--border);
        }

        .history-pagination button {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all var(--transition);
        }

        .history-pagination button:hover:not(:disabled) {
            background: var(--accent);
            color: white;
        }

        .history-pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .history-pagination span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* ========== IMMERSIVE MODE ========== */
        .immersive {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .immersive.active {
            display: flex;
        }

        .immersive-image {
            max-width: 90%;
            max-height: 75%;
            object-fit: contain;
            border-radius: var(--radius);
            transition: opacity 0.4s ease;
        }

        .immersive-timer {
            position: absolute;
            top: 24px;
            right: 24px;
            font-size: 2.5rem;
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            color: var(--accent-secondary);
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .immersive-hint {
            position: absolute;
            bottom: 32px;
            font-size: 0.9rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 24px;
            border-radius: 50px;
        }

        .immersive-hint kbd {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-family: inherit;
            color: var(--accent);
        }

        .immersive-close {
            position: absolute;
            top: 24px;
            left: 24px;
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            border-radius: 50%;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .immersive-close:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        /* ========== HELP MODAL ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-width: 440px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: var(--bg-elevated);
            border: none;
            border-radius: 50%;
            color: var(--text-dim);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .modal-close:hover {
            color: white;
            background: var(--danger);
        }

        .modal-body {
            padding: 24px;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-list {
            list-style: none;
        }

        .help-list li {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .help-list li:last-child {
            border-bottom: none;
        }

        .help-list kbd {
            min-width: 50px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border-radius: 6px;
            text-align: center;
            font-family: inherit;
            font-size: 0.8rem;
            color: var(--accent);
        }

        /* ========== MOBILE ========== */
        @media (max-width: 600px) {
            .view {
                padding: 16px;
            }

            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .train-stats {
                gap: 20px;
                padding: 16px;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .history-filters {
                width: 100%;
                flex-direction: column;
            }

            .history-item {
                flex-wrap: wrap;
                gap: 8px;
            }

            .immersive-timer {
                font-size: 1.8rem;
                top: 16px;
                right: 16px;
            }

            .immersive-close {
                top: 16px;
                left: 16px;
                width: 40px;
                height: 40px;
            }
        }

        /* Hidden file input */
        #file-input {
            display: none;
        }
    </style>
</head>

<body>
    <input type="file" id="file-input" accept="image/*">

    <div class="app">
        <!-- Views Container -->
        <div class="views">
            <!-- Train View -->
            <div class="view train-view active" id="train-view">
                <div class="train-empty" id="train-empty">
                    <div class="train-empty-icon">üëÅÔ∏è</div>
                    <h2>Ready to Train?</h2>
                    <p>Select an image from your gallery to start visualization training. Hold to hide the image and
                        visualize it in your mind.</p>
                    <button class="train-empty-btn" id="go-gallery-btn">
                        <span>üñºÔ∏è</span> Open Gallery
                    </button>
                </div>

                <div class="train-active" id="train-active">
                    <div class="train-image-wrap" id="train-image-wrap">
                        <img class="train-image" id="train-image" src="" alt="Training image">
                        <div class="train-tap-hint">Tap to enter focus mode</div>
                    </div>
                    <div class="train-stats">
                        <div class="train-stat">
                            <div class="train-stat-value" id="train-best">0.00s</div>
                            <div class="train-stat-label">Best Time</div>
                        </div>
                        <div class="train-stat">
                            <div class="train-stat-value" id="train-sessions">0</div>
                            <div class="train-stat-label">Sessions</div>
                        </div>
                        <div class="train-stat">
                            <div class="train-stat-value" id="train-total">0m</div>
                            <div class="train-stat-label">Total Time</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gallery View -->
            <div class="view" id="gallery-view">
                <div class="gallery-header">
                    <h1>Gallery</h1>
                    <span class="gallery-count" id="gallery-count">0 images</span>
                </div>
                <div class="gallery-grid" id="gallery-grid">
                    <div class="gallery-add" id="add-image-btn">
                        <span class="gallery-add-icon">+</span>
                        <span class="gallery-add-text">Add Image</span>
                    </div>
                </div>
            </div>

            <!-- Stats View -->
            <div class="view" id="stats-view">
                <div class="stats-header">
                    <h1>Statistics</h1>
                    <p>Your visualization training progress</p>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-total-sessions">0</div>
                        <div class="stat-card-label">Total Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-total-time">0m</div>
                        <div class="stat-card-label">Total Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-best-ever">0.00s</div>
                        <div class="stat-card-label">Best Ever</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-images">0</div>
                        <div class="stat-card-label">Images</div>
                    </div>
                </div>

                <div class="history-section">
                    <div class="history-header">
                        <h3>Recent Sessions</h3>
                        <div class="history-filters">
                            <select id="filter-image">
                                <option value="">All Images</option>
                            </select>
                            <select id="filter-per-page">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    <div class="history-list" id="history-list"></div>
                    <div class="history-pagination">
                        <button id="prev-page">‚Üê Prev</button>
                        <span id="page-info">Page 1 of 1</span>
                        <button id="next-page">Next ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="nav">
            <button class="nav-btn active" data-view="train-view">
                <span class="icon">üéØ</span>
                <span>Train</span>
            </button>
            <button class="nav-btn" data-view="gallery-view">
                <span class="icon">üñºÔ∏è</span>
                <span>Gallery</span>
            </button>
            <button class="nav-btn" data-view="stats-view">
                <span class="icon">üìä</span>
                <span>Stats</span>
            </button>
            <button class="nav-btn" id="help-nav-btn">
                <span class="icon">‚ùì</span>
                <span>Help</span>
            </button>
        </nav>
    </div>

    <!-- Immersive Training Mode -->
    <div class="immersive" id="immersive">
        <button class="immersive-close" id="immersive-close">‚úï</button>
        <div class="immersive-timer" id="immersive-timer">0.00s</div>
        <img class="immersive-image" id="immersive-image" src="" alt="Focus image">
        <div class="immersive-hint">
            Hold <kbd>Space</kbd> or tap & hold to visualize ‚Ä¢ <kbd>Esc</kbd> to exit
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>üìñ How to Use</h2>
                <button class="modal-close" id="help-close">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>üéØ Training</h3>
                    <ul class="help-list">
                        <li>1. Add images in the Gallery tab</li>
                        <li>2. Select an image to train with</li>
                        <li>3. Tap the image to enter focus mode</li>
                        <li>4. Study the image, then hold to hide it</li>
                        <li>5. Visualize in your mind as long as you can!</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>‚å®Ô∏è Keyboard</h3>
                    <ul class="help-list">
                        <li><kbd>Space</kbd> Hold to visualize</li>
                        <li><kbd>Esc</kbd> Exit focus mode</li>
                        <li><kbd>1-4</kbd> Switch tabs</li>
                        <li><kbd>?</kbd> Toggle help</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>üí° Tips</h3>
                    <ul class="help-list">
                        <li>Start with simple images</li>
                        <li>Practice daily for best results</li>
                        <li>Try to beat your best time!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== DOM ==========
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);

        const fileInput = $('file-input');
        const views = $$('.view');
        const navBtns = $$('.nav-btn[data-view]');
        const helpNavBtn = $('help-nav-btn');
        const trainView = $('train-view');
        const trainEmpty = $('train-empty');
        const trainActive = $('train-active');
        const trainImage = $('train-image');
        const trainImageWrap = $('train-image-wrap');
        const trainBest = $('train-best');
        const trainSessions = $('train-sessions');
        const trainTotal = $('train-total');
        const goGalleryBtn = $('go-gallery-btn');
        const galleryView = $('gallery-view');
        const galleryGrid = $('gallery-grid');
        const galleryCount = $('gallery-count');
        const addImageBtn = $('add-image-btn');
        const statsView = $('stats-view');
        const statTotalSessions = $('stat-total-sessions');
        const statTotalTime = $('stat-total-time');
        const statBestEver = $('stat-best-ever');
        const statImages = $('stat-images');
        const filterImage = $('filter-image');
        const filterPerPage = $('filter-per-page');
        const historyList = $('history-list');
        const pageInfo = $('page-info');
        const prevPage = $('prev-page');
        const nextPage = $('next-page');
        const immersive = $('immersive');
        const immersiveImage = $('immersive-image');
        const immersiveTimer = $('immersive-timer');
        const immersiveClose = $('immersive-close');
        const helpModal = $('help-modal');
        const helpClose = $('help-close');

        // ========== STATE ==========
        let images = [];
        let selectedImageId = null;
        let isImmersive = false;
        let isVisualizing = false;
        let timerInterval = null;
        let seconds = 0;
        let historyPage = 1;
        let historyPerPage = 10;
        let historyImageFilter = '';

        // ========== STORAGE ==========
        const save = () => localStorage.setItem('visutrain_data', JSON.stringify(images));

        const load = () => {
            try {
                const data = localStorage.getItem('visualizationTrainerData') || localStorage.getItem('visutrain_data');
                if (data) {
                    images = JSON.parse(data).map(img => ({
                        ...img,
                        sessions: (img.sessions || []).map(s =>
                            typeof s === 'number'
                                ? { time: s, date: new Date().toISOString(), note: '' }
                                : { time: s.time || 0, date: s.date || new Date().toISOString(), note: s.note || '' }
                        )
                    }));
                }
            } catch (e) {
                console.error('Load error:', e);
                images = [];
            }
        };

        // ========== NAVIGATION ==========
        function switchView(viewId) {
            views.forEach(v => v.classList.remove('active'));
            $(viewId).classList.add('active');
            navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewId));

            if (viewId === 'gallery-view') renderGallery();
            if (viewId === 'stats-view') renderStats();
            if (viewId === 'train-view') renderTrain();
        }

        navBtns.forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.dataset.view));
        });

        goGalleryBtn.addEventListener('click', () => switchView('gallery-view'));

        // ========== GALLERY ==========
        function renderGallery() {
            galleryGrid.innerHTML = '';

            // Add button first
            const addCard = document.createElement('div');
            addCard.className = 'gallery-add';
            addCard.innerHTML = '<span class="gallery-add-icon">+</span><span class="gallery-add-text">Add Image</span>';
            addCard.addEventListener('click', () => fileInput.click());
            galleryGrid.appendChild(addCard);

            images.forEach(img => {
                const card = document.createElement('div');
                card.className = 'gallery-card' + (img.id === selectedImageId ? ' selected' : '');
                card.innerHTML = `
                    <img src="${img.src}" alt="Gallery image">
                    <div class="gallery-card-overlay">
                        <div class="gallery-card-best">${(img.highScore || 0).toFixed(2)}s</div>
                        <div class="gallery-card-sessions">${(img.sessions || []).length} sessions</div>
                    </div>
                    <button class="gallery-card-delete">‚úï</button>
                `;

                card.addEventListener('click', e => {
                    if (e.target.classList.contains('gallery-card-delete')) {
                        e.stopPropagation();
                        if (confirm('Delete this image?')) {
                            images = images.filter(i => i.id !== img.id);
                            if (selectedImageId === img.id) selectedImageId = null;
                            save();
                            renderGallery();
                            renderTrain();
                        }
                        return;
                    }
                    selectedImageId = img.id;
                    save();
                    renderGallery();
                    switchView('train-view');
                });

                galleryGrid.appendChild(card);
            });

            galleryCount.textContent = `${images.length} image${images.length !== 1 ? 's' : ''}`;
        }

        // ========== FILE UPLOAD ==========
        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = ev => {
                const newImg = {
                    id: `img_${Date.now()}`,
                    src: ev.target.result,
                    sessions: [],
                    highScore: 0
                };
                images.push(newImg);
                selectedImageId = newImg.id;
                save();
                renderGallery();
                switchView('train-view');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        // ========== TRAIN VIEW ==========
        function renderTrain() {
            const img = images.find(i => i.id === selectedImageId);

            if (!img) {
                trainEmpty.classList.remove('hidden');
                trainActive.classList.remove('visible');
                return;
            }

            trainEmpty.classList.add('hidden');
            trainActive.classList.add('visible');
            trainImage.src = img.src;
            immersiveImage.src = img.src;

            trainBest.textContent = `${(img.highScore || 0).toFixed(2)}s`;
            trainSessions.textContent = (img.sessions || []).length;

            const totalSec = (img.sessions || []).reduce((sum, s) => sum + s.time, 0);
            trainTotal.textContent = formatTime(totalSec);
        }

        function formatTime(sec) {
            if (sec < 60) return `${sec.toFixed(0)}s`;
            if (sec < 3600) return `${(sec / 60).toFixed(1)}m`;
            return `${(sec / 3600).toFixed(1)}h`;
        }

        trainImageWrap.addEventListener('click', () => {
            if (selectedImageId) enterImmersive();
        });

        // ========== IMMERSIVE MODE ==========
        async function enterImmersive() {
            isImmersive = true;
            immersive.classList.add('active');
            immersiveImage.style.opacity = '1';
            immersiveTimer.textContent = '0.00s';

            // Request browser fullscreen
            try {
                if (immersive.requestFullscreen) {
                    await immersive.requestFullscreen();
                } else if (immersive.webkitRequestFullscreen) {
                    await immersive.webkitRequestFullscreen();
                } else if (immersive.msRequestFullscreen) {
                    await immersive.msRequestFullscreen();
                }
            } catch (e) {
                console.log('Fullscreen not available:', e);
            }
        }

        async function exitImmersive() {
            if (isVisualizing) stopVisualize();
            isImmersive = false;
            immersive.classList.remove('active');

            // Exit browser fullscreen
            try {
                if (document.fullscreenElement) {
                    await document.exitFullscreen();
                } else if (document.webkitFullscreenElement) {
                    await document.webkitExitFullscreen();
                } else if (document.msFullscreenElement) {
                    await document.msExitFullscreen();
                }
            } catch (e) {
                console.log('Exit fullscreen error:', e);
            }
        }

        // Handle browser fullscreen exit (user pressed Esc directly)
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isImmersive) {
                isImmersive = false;
                immersive.classList.remove('active');
                if (isVisualizing) stopVisualize();
            }
        });

        immersiveClose.addEventListener('click', exitImmersive);

        immersive.addEventListener('click', e => {
            if (e.target === immersive && !isVisualizing) {
                exitImmersive();
            }
        });

        // ========== VISUALIZATION ==========
        function startVisualize() {
            if (!selectedImageId || isVisualizing) return;

            isVisualizing = true;
            seconds = 0;
            const start = Date.now();

            immersiveImage.style.opacity = '0';

            timerInterval = setInterval(() => {
                seconds = (Date.now() - start) / 1000;
                immersiveTimer.textContent = `${seconds.toFixed(2)}s`;
            }, 16);
        }

        function stopVisualize() {
            if (!timerInterval) return;

            clearInterval(timerInterval);
            timerInterval = null;
            isVisualizing = false;

            immersiveImage.style.opacity = '1';

            if (seconds > 0.2) {
                const img = images.find(i => i.id === selectedImageId);
                if (img) {
                    img.sessions.unshift({
                        time: seconds,
                        date: new Date().toISOString(),
                        note: ''
                    });
                    if (seconds > img.highScore) img.highScore = seconds;
                    save();
                    renderTrain();
                }
            }
        }

        // Touch/mouse for immersive
        let touchStarted = false;

        immersive.addEventListener('mousedown', e => {
            if (e.target !== immersiveClose && isImmersive) {
                startVisualize();
            }
        });

        immersive.addEventListener('mouseup', () => {
            if (isVisualizing) stopVisualize();
        });

        immersive.addEventListener('touchstart', e => {
            if (e.target !== immersiveClose && isImmersive) {
                touchStarted = true;
                startVisualize();
            }
        }, { passive: true });

        immersive.addEventListener('touchend', () => {
            if (touchStarted && isVisualizing) {
                stopVisualize();
            }
            touchStarted = false;
        });

        // ========== STATS VIEW ==========
        function renderStats() {
            // Global stats
            let totalSessions = 0;
            let totalTime = 0;
            let bestEver = 0;

            images.forEach(img => {
                (img.sessions || []).forEach(s => {
                    totalSessions++;
                    totalTime += s.time;
                    if (s.time > bestEver) bestEver = s.time;
                });
            });

            statTotalSessions.textContent = totalSessions;
            statTotalTime.textContent = formatTime(totalTime);
            statBestEver.textContent = `${bestEver.toFixed(2)}s`;
            statImages.textContent = images.length;

            // Filter dropdown
            filterImage.innerHTML = '<option value="">All Images</option>';
            images.forEach((img, i) => {
                filterImage.innerHTML += `<option value="${img.id}">Image ${i + 1}</option>`;
            });
            filterImage.value = historyImageFilter;

            renderHistory();
        }

        function renderHistory() {
            let allSessions = [];

            images.forEach(img => {
                if (historyImageFilter && img.id !== historyImageFilter) return;
                (img.sessions || []).forEach(s => {
                    allSessions.push({ ...s, imageId: img.id });
                });
            });

            // Sort by date desc
            allSessions.sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalPages = Math.ceil(allSessions.length / historyPerPage) || 1;
            historyPage = Math.max(1, Math.min(historyPage, totalPages));

            const start = (historyPage - 1) * historyPerPage;
            const paginated = allSessions.slice(start, start + historyPerPage);

            if (paginated.length === 0) {
                historyList.innerHTML = '<div class="history-empty">No sessions recorded yet</div>';
            } else {
                historyList.innerHTML = paginated.map(s => `
                    <div class="history-item" data-date="${s.date}" data-image="${s.imageId}">
                        <span class="history-item-time">${s.time.toFixed(2)}s</span>
                        <span class="history-item-date">${new Date(s.date).toLocaleString()}</span>
                        <span class="history-item-note">${s.note || '-'}</span>
                        <button class="history-item-delete">‚úï</button>
                    </div>
                `).join('');
            }

            pageInfo.textContent = `Page ${historyPage} of ${totalPages}`;
            prevPage.disabled = historyPage <= 1;
            nextPage.disabled = historyPage >= totalPages;
        }

        historyList.addEventListener('click', e => {
            if (e.target.classList.contains('history-item-delete')) {
                const item = e.target.closest('.history-item');
                const date = item.dataset.date;
                const imageId = item.dataset.image;

                const img = images.find(i => i.id === imageId);
                if (img) {
                    img.sessions = img.sessions.filter(s => s.date !== date);
                    // Recalculate high score
                    img.highScore = Math.max(0, ...img.sessions.map(s => s.time));
                    save();
                    renderStats();
                    renderTrain();
                }
            }
        });

        filterImage.addEventListener('change', () => {
            historyImageFilter = filterImage.value;
            historyPage = 1;
            renderHistory();
        });

        filterPerPage.addEventListener('change', () => {
            historyPerPage = parseInt(filterPerPage.value);
            historyPage = 1;
            renderHistory();
        });

        prevPage.addEventListener('click', () => {
            if (historyPage > 1) {
                historyPage--;
                renderHistory();
            }
        });

        nextPage.addEventListener('click', () => {
            historyPage++;
            renderHistory();
        });

        // ========== HELP MODAL ==========
        function toggleHelp(show) {
            helpModal.classList.toggle('active', show);
        }

        helpNavBtn.addEventListener('click', () => toggleHelp(true));
        helpClose.addEventListener('click', () => toggleHelp(false));
        helpModal.addEventListener('click', e => {
            if (e.target === helpModal) toggleHelp(false);
        });

        // ========== KEYBOARD ==========
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    if (isImmersive && !isVisualizing) {
                        startVisualize();
                    } else if (selectedImageId && !isImmersive) {
                        enterImmersive();
                    }
                    break;
                case 'Escape':
                    if (helpModal.classList.contains('active')) {
                        toggleHelp(false);
                    } else if (isImmersive) {
                        exitImmersive();
                    }
                    break;
                case '1':
                    switchView('train-view');
                    break;
                case '2':
                    switchView('gallery-view');
                    break;
                case '3':
                    switchView('stats-view');
                    break;
                case '4':
                case '?':
                    toggleHelp(!helpModal.classList.contains('active'));
                    break;
            }
        });

        document.addEventListener('keyup', e => {
            if (e.key === ' ' && isVisualizing) {
                stopVisualize();
            }
        });

        // ========== INIT ==========
        load();
        if (images.length > 0 && !selectedImageId) {
            selectedImageId = images[0].id;
        }
        renderTrain();
        renderGallery();
    </script>
</body>

</html>