<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualization Trainer</title>

    <!-- ======== CSS STYLES ======== -->
    <style>
        :root { --bg-color: #121212; --surface-color: #1e1e1e; --primary-color: #bb86fc; --primary-variant: #3700b3; --secondary-color: #03dac6; --on-bg-color: #e0e0e0; --on-surface-color: #cccccc; --border-color: #333333; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--on-bg-color); user-select: none; -webkit-user-select: none;
            /* This is the rule that prevents scrolling on desktop */
            overflow: hidden; 
        }
        #background-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .app-container { display: flex; height: 100vh; position: relative; z-index: 1; }
        .sidebar { width: 320px; background-color: var(--surface-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 2; flex-shrink: 0; }
        .sidebar header { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .sidebar h1 { font-size: 1.5rem; margin-bottom: 20px; color: var(--primary-color); }
        .add-image-btn { display: block; width: 100%; padding: 10px; background-color: var(--primary-variant); color: white; text-align: center; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        .add-image-btn:hover { background-color: var(--primary-color); }
        .image-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .image-widget { display: flex; align-items: center; padding: 10px; margin-bottom: 10px; background-color: var(--bg-color); border-radius: 5px; border: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .image-widget:hover { background-color: #2a2a2a; }
        .image-widget.active { border-color: var(--primary-color); background-color: #252030; }
        .image-widget-thumbnail { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; margin-right: 15px; }
        .image-widget-info { flex-grow: 1; min-width: 0; }
        .image-widget-info p { font-size: 0.9rem; color: var(--on-surface-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-btn { background: none; border: none; color: #888; font-size: 1.2rem; cursor: pointer; transition: color 0.2s; padding: 5px; flex-shrink: 0; }
        .delete-btn:hover { color: #ff6b6b; }
        .footer-credit { padding: 15px 20px; font-size: 0.75rem; color: #777; text-align: center; border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .footer-credit a { color: #999; text-decoration: none; }
        .footer-credit a:hover { color: var(--secondary-color); }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; padding: 20px; height: 100vh; background-color: transparent; }
        .viewer-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .welcome-message { text-align: center; color: var(--on-surface-color); }
        .welcome-message h2 { margin-bottom: 10px; }
        #image-display-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; overflow: hidden; margin-bottom: 20px; min-height: 150px; }
        #main-image { max-width: 100%; max-height: 100%; object-fit: contain; transition: opacity 0.3s ease; }
        .controls { width: 100%; max-width: 800px; background-color: var(--surface-color); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); flex-shrink: 0; }
        .top-controls { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 20px; }
        .slider-container { flex-grow: 1; display: flex; align-items: center; }
        .slider-container label { margin-right: 10px; }
        .timer-display { font-size: 2.5rem; text-align: center; color: var(--secondary-color); font-variant-numeric: tabular-nums; }
        #visualize-btn { width: 100%; padding: 15px; font-size: 1.2rem; font-weight: bold; background-color: var(--secondary-color); color: var(--bg-color); border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; transition: transform 0.1s, box-shadow 0.1s; }
        #visualize-btn:active { transform: scale(0.98); box-shadow: 0 0 10px var(--secondary-color); }
        .hidden { display: none !important; }

        input[type="range"] { flex-grow: 1; -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; height: 15px; }
        input[type="range"]::-webkit-slider-runnable-track { background: linear-gradient(to right, var(--secondary-color) var(--slider-progress, 0%), var(--border-color) var(--slider-progress, 0%)); height: 5px; border-radius: 5px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -5px; background-color: var(--secondary-color); height: 15px; width: 15px; border-radius: 50%; border: 2px solid var(--surface-color); box-shadow: 0 0 5px rgba(3, 218, 198, 0.5); }
        
        .session-history { margin-top: 20px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .history-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .history-controls label, .history-controls input, .history-controls select, .history-controls button { font-size: 0.8rem; }
        .history-controls input, .history-controls select { background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--on-bg-color); padding: 5px; border-radius: 4px; }
        .history-controls button { background-color: var(--primary-variant); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .history-controls button:hover { background-color: var(--primary-color); }
        .history-table-container { max-height: 150px; overflow-y: auto; background-color: var(--bg-color); border-radius: 5px; border: 1px solid var(--border-color); }
        #history-table { width: 100%; border-collapse: collapse; }
        #history-table th, #history-table td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        #history-table th { background-color: #2a2a2a; position: sticky; top: 0; z-index: 1; }
        #history-table td:nth-child(3) { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        #history-table tr:last-child td { border-bottom: none; }
        #history-table tr:hover td { background-color: #252030; }
        .pagination-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; font-size: 0.9rem; }
        .pagination-controls button { background: none; border: 1px solid var(--border-color); color: var(--on-surface-color); padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .pagination-controls button:disabled { opacity: 0.3; cursor: not-allowed; }
        .pagination-controls button:not(:disabled):hover { background-color: var(--border-color); }
        .delete-log-btn { background: none; border: none; color: #888; cursor: pointer; font-size: 1.1rem; }
        .delete-log-btn:hover { color: #ff6b6b; }
        #session-note-input { width: 100%; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--on-bg-color); padding: 8px; border-radius: 4px; margin-top: 20px; }

        /* --- MOBILE RESPONSIVE STYLES --- */
        @media (max-width: 768px) {
            body {
                overflow: auto; /* THE FIX: Allows the main body to scroll on mobile */
            }
            .app-container { flex-direction: column; height: auto; min-height: 100vh; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-color); }
            .image-list { max-height: 25vh; } 
            .main-content { height: auto; flex-grow: 1; padding: 15px; }
            .top-controls { flex-direction: column; gap: 15px; }
            .timer-display { order: -1; }
            .history-controls { flex-direction: column; align-items: stretch; gap: 8px; }
            .history-controls > div { display: flex; flex-direction: column; gap: 8px; }
            .history-table-container { overflow-x: auto; }
            #history-table { min-width: 500px; }
        }
    </style>
</head>
<body>
    <canvas id="background-canvas"></canvas>
    <div class="app-container">
        <aside class="sidebar">
            <header><h1>VisuTrain</h1><label for="image-upload" class="add-image-btn">Add New Image</label><input type="file" id="image-upload" accept="image/*" style="display: none;"></header>
            <div id="image-list" class="image-list"></div>
            <footer class="footer-credit">Made by @ramses13th<br>Member of <a href="https://templeofzeus.org" target="_blank">templeofzeus.org</a></footer>
        </aside>
        <main class="main-content">
            <div id="viewer" class="viewer-container">
                <div id="welcome-message" class="welcome-message"><h2>Welcome to Visualization Trainer</h2><p>Add an image from the sidebar to begin your training.</p></div>
                <div id="image-display-area" class="hidden"><img id="main-image" src="" alt="Visualization Image"></div>
                <div id="controls-area" class="controls hidden">
                    <div class="top-controls"><div class="slider-container"><label for="size-slider">Size:</label><input type="range" id="size-slider" min="20" max="100" value="100"></div><div class="timer-display"><span id="timer">0.00</span>s</div></div>
                    <div class="session-history">
                        <div class="history-header"><h3>Session History (<span id="high-score">N/A</span>)</h3><div class="history-controls"><label for="items-per-page">Show:</label><select id="items-per-page"><option value="10">10</option><option value="25">25</option><option value="50">50</option></select></div></div>
                        <div class="history-controls" style="margin-bottom: 10px; justify-content: space-between;">
                            <div><label>From:</label> <input type="date" id="start-date-filter"><label>To:</label> <input type="date" id="end-date-filter"></div>
                            <div><button id="filter-btn">Filter</button><button id="clear-filter-btn">Clear</button></div>
                        </div>
                        <div class="history-table-container"><table id="history-table"><thead><tr><th>Time</th><th>Date</th><th>Note</th><th>Actions</th></tr></thead><tbody id="session-list-body"></tbody></table></div>
                        <div class="pagination-controls"><button id="prev-page-btn">&laquo; Prev</button><span id="page-info">Page 1 of 1</span><button id="next-page-btn">Next &raquo;</button></div>
                    </div>
                    <input type="text" id="session-note-input" placeholder="Add a short note...">
                    <button id="visualize-btn">Hold to Visualize</button>
                </div>
            </div>
        </main>
    </div>

    <!-- ======== JAVASCRIPT LOGIC ======== -->
    <script>
        const canvas = document.getElementById('background-canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight; let particlesArray;
        class Particle { constructor(x,y,dX,dY,s){this.x=x;this.y=y;this.directionX=dX;this.directionY=dY;this.size=s;} draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2,false);ctx.fillStyle='rgba(187,134,252,0.2)';ctx.fill();} update(){if(this.x>canvas.width||this.x<0){this.directionX=-this.directionX;} if(this.y>canvas.height||this.y<0){this.directionY=-this.directionY;} this.x+=this.directionX;this.y+=this.directionY;this.draw();}}
        function initParticles(){particlesArray=[];let num=(canvas.height*canvas.width)/15000;for(let i=0;i<num;i++){let s=(Math.random()*2)+1;let x=(Math.random()*((innerWidth-s*2)-(s*2))+s*2);let y=(Math.random()*((innerHeight-s*2)-(s*2))+s*2);let dX=(Math.random()*0.4)-0.2;let dY=(Math.random()*0.4)-0.2;particlesArray.push(new Particle(x,y,dX,dY,s));}}
        function animateParticles(){requestAnimationFrame(animateParticles);ctx.clearRect(0,0,innerWidth,innerHeight);for(let p of particlesArray){p.update();}}
        window.addEventListener('resize',()=>{canvas.width=innerWidth;canvas.height=innerHeight;initParticles(); syncSliderToImageSize();}); initParticles(); animateParticles();

        const getEl = (id) => document.getElementById(id);
        const imageUpload = getEl('image-upload'), imageList = getEl('image-list'), welcomeMessage = getEl('welcome-message'), imageDisplayArea = getEl('image-display-area'), controlsArea = getEl('controls-area'), mainImage = getEl('main-image'), sizeSlider = getEl('size-slider'), timerDisplay = getEl('timer'), visualizeBtn = getEl('visualize-btn'), highScoreDisplay = getEl('high-score'), sessionListBody = getEl('session-list-body'), itemsPerPageSelect = getEl('items-per-page'), startDateFilter = getEl('start-date-filter'), endDateFilter = getEl('end-date-filter'), filterBtn = getEl('filter-btn'), clearFilterBtn = getEl('clear-filter-btn'), prevPageBtn = getEl('prev-page-btn'), nextPageBtn = getEl('next-page-btn'), pageInfo = getEl('page-info'), sessionNoteInput = getEl('session-note-input');
        
        let imagesData = []; let activeImageId = null; let timerInterval = null; let seconds = 0;
        let historyState = { currentPage: 1, itemsPerPage: 10, startDate: null, endDate: null };

        const saveData = () => localStorage.setItem('visualizationTrainerData', JSON.stringify(imagesData));
        const migrateData = (data) => { return data.map(image => { if (!image.sessions) image.sessions = []; image.sessions = image.sessions.map(session => { if (typeof session === 'number') { return { time: session, date: new Date(0).toISOString(), note: '' }; } if (typeof session === 'object' && session !== null) { return { time: typeof session.time === 'number' ? session.time : 0, date: session.date || new Date(0).toISOString(), note: session.note || '' }; } return { time: 0, date: new Date(0).toISOString(), note: 'Invalid session data' }; }); return image; }); };
        const loadData = () => { const data = localStorage.getItem('visualizationTrainerData'); if (data) { try { let parsedData = JSON.parse(data); imagesData = migrateData(parsedData); } catch (e) { console.error("Failed to load or migrate data:", e); imagesData = []; } renderImageList(); } };
        const updateSliderProgress = () => { const progress = (sizeSlider.value - sizeSlider.min) / (sizeSlider.max - sizeSlider.min) * 100; sizeSlider.style.setProperty('--slider-progress', `${progress}%`); };
        
        const syncSliderToImageSize = () => { if (!mainImage.naturalWidth || !imageDisplayArea.clientWidth) return; const contW = imageDisplayArea.clientWidth, contH = imageDisplayArea.clientHeight, imgW = mainImage.naturalWidth, imgH = mainImage.naturalHeight; const contRatio = contW / contH, imgRatio = imgW / imgH; let maxSizePercent = 100; if (imgRatio < contRatio) { const optimalWidth = contH * imgRatio; maxSizePercent = (optimalWidth / contW) * 100; } sizeSlider.value = maxSizePercent; mainImage.style.width = `${maxSizePercent}%`; updateSliderProgress(); };
        
        const renderImageList = () => { imageList.innerHTML = ''; imagesData.forEach(img => { const widget = document.createElement('div'); widget.className = 'image-widget'; widget.dataset.id = img.id; if (img.id === activeImageId) widget.classList.add('active'); widget.innerHTML = `<img src="${img.src}" alt="Thumbnail" class="image-widget-thumbnail"><div class="image-widget-info"><p>High Score: ${(img.highScore || 0).toFixed(2)}s</p><p>${(img.sessions || []).length} sessions</p></div><button class="delete-btn" data-id="${img.id}">×</button>`; imageList.appendChild(widget); }); };

        const renderSessionHistory = () => {
            const activeImage = imagesData.find(img => img.id === activeImageId);
            if (!activeImage || activeImage.sessions.length === 0) {
                sessionListBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No sessions yet.</td></tr>';
                pageInfo.textContent = 'Page 1 of 1'; prevPageBtn.disabled = true; nextPageBtn.disabled = true; return;
            }
            let filteredSessions = activeImage.sessions;
            if (historyState.startDate && historyState.endDate) { filteredSessions = activeImage.sessions.filter(s => { const sessionDate = new Date(s.date); return sessionDate >= historyState.startDate && sessionDate <= historyState.endDate; }); }
            const totalPages = Math.ceil(filteredSessions.length / historyState.itemsPerPage) || 1;
            historyState.currentPage = Math.max(1, Math.min(historyState.currentPage, totalPages));
            const paginatedSessions = filteredSessions.slice((historyState.currentPage - 1) * historyState.itemsPerPage, historyState.currentPage * historyState.itemsPerPage);
            sessionListBody.innerHTML = '';
            paginatedSessions.forEach(session => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${session.time.toFixed(2)}s</td><td>${new Date(session.date).toLocaleString()}</td><td>${session.note}</td><td><button class="delete-log-btn" data-date="${session.date}">×</button></td>`;
                sessionListBody.appendChild(row);
});
            pageInfo.textContent = `Page ${historyState.currentPage} of ${totalPages}`;
            prevPageBtn.disabled = historyState.currentPage === 1;
            nextPageBtn.disabled = historyState.currentPage === totalPages;
        };

        const renderActiveImage = () => {
            if (!activeImageId || !imagesData.find(img => img.id === activeImageId)) {
                activeImageId = null; welcomeMessage.classList.remove('hidden'); imageDisplayArea.classList.add('hidden'); controlsArea.classList.add('hidden'); return;
            }
            const activeImage = imagesData.find(img => img.id === activeImageId);
            welcomeMessage.classList.add('hidden'); imageDisplayArea.classList.remove('hidden'); controlsArea.classList.remove('hidden');
            mainImage.src = activeImage.src;
            const trySync = () => requestAnimationFrame(syncSliderToImageSize);
            mainImage.onload = trySync; if (mainImage.complete) trySync();
            highScoreDisplay.textContent = `High Score: ${(activeImage.highScore || 0).toFixed(2)}s`;
            historyState.currentPage = 1; renderSessionHistory();
            document.querySelectorAll('.image-widget').forEach(widget => widget.classList.toggle('active', widget.dataset.id === activeImageId));
        };

        const handleImageUpload = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const newImage = { id: `img_${Date.now()}`, src: e.target.result, sessions: [], highScore: 0 }; imagesData.push(newImage); activeImageId = newImage.id; saveData(); renderImageList(); renderActiveImage(); }; reader.readAsDataURL(file); e.target.value = ''; };
        const handleImageListClick = (e) => { const widget = e.target.closest('.image-widget'); if (!widget) return; if (e.target.classList.contains('delete-btn')) { const id = e.target.dataset.id; if (confirm('Delete image and all its data?')) { imagesData = imagesData.filter(img => img.id !== id); if(activeImageId === id) activeImageId = imagesData.length > 0 ? imagesData[0].id : null; saveData(); renderImageList(); renderActiveImage(); } } else { activeImageId = widget.dataset.id; renderActiveImage(); } };
        const handleSizeChange = () => { mainImage.style.width = `${sizeSlider.value}%`; updateSliderProgress(); };
        const startTimer = () => { if (!activeImageId) return; mainImage.style.opacity = '0'; seconds = 0; const startTime = Date.now(); timerInterval = setInterval(() => { seconds = (Date.now() - startTime) / 1000; timerDisplay.textContent = seconds.toFixed(2); }, 10); };
        const stopTimer = () => { if (!timerInterval) return; clearInterval(timerInterval); timerInterval = null; mainImage.style.opacity = '1'; const activeImage = imagesData.find(img => img.id === activeImageId); if (activeImage) { const session = { time: seconds, date: new Date().toISOString(), note: sessionNoteInput.value }; activeImage.sessions.unshift(session); if (seconds > activeImage.highScore) activeImage.highScore = seconds; sessionNoteInput.value = ''; saveData(); renderImageList(); renderActiveImage(); } };
        
        sessionListBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-log-btn')) {
                const dateToDelete = e.target.dataset.date;
                const activeImage = imagesData.find(img => img.id === activeImageId);
                if (activeImage) { activeImage.sessions = activeImage.sessions.filter(s => s.date !== dateToDelete); saveData(); renderSessionHistory(); renderImageList(); }
            }
        });

        itemsPerPageSelect.addEventListener('change', () => { historyState.itemsPerPage = parseInt(itemsPerPageSelect.value); historyState.currentPage = 1; renderSessionHistory(); });
        filterBtn.addEventListener('click', () => { const start = startDateFilter.value ? new Date(startDateFilter.value) : null; const end = endDateFilter.value ? new Date(endDateFilter.value) : null; if(start) start.setHours(0,0,0,0); if(end) end.setHours(23,59,59,999); historyState.startDate = start; historyState.endDate = end; historyState.currentPage = 1; renderSessionHistory(); });
        clearFilterBtn.addEventListener('click', () => { startDateFilter.value = ''; endDateFilter.value = ''; historyState.startDate = null; historyState.endDate = null; historyState.currentPage = 1; renderSessionHistory(); });
        prevPageBtn.addEventListener('click', () => { if (historyState.currentPage > 1) { historyState.currentPage--; renderSessionHistory(); } });
        nextPageBtn.addEventListener('click', () => { historyState.currentPage++; renderSessionHistory(); });
        imageUpload.addEventListener('change', handleImageUpload); imageList.addEventListener('click', handleImageListClick); sizeSlider.addEventListener('input', handleSizeChange); visualizeBtn.addEventListener('mousedown', startTimer); visualizeBtn.addEventListener('mouseup', stopTimer); visualizeBtn.addEventListener('mouseleave', stopTimer); visualizeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startTimer(); }); visualizeBtn.addEventListener('touchend', stopTimer);
        
        loadData();
        if (imagesData.length > 0) { activeImageId = imagesData.find(img => img.id)?.id || null; }
        renderActiveImage();
    </script>
</body>
</html>
