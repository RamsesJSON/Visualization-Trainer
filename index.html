<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VisuTrain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        :root {
            --bg-dark: #0c0c0c;
            --bg-card: #141414;
            --bg-elevated: #1a1a1a;
            --gold: #d4af37;
            --gold-light: #f4e4a6;
            --gold-dark: #a68b2a;
            --gold-glow: rgba(212, 175, 55, 0.25);
            --text: #f5f5f5;
            --text-dim: #a0a0a0;
            --text-muted: #666;
            --border: rgba(212, 175, 55, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --danger: #c94040;
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --nav-height: 72px;
            --font-display: 'Cormorant Garamond', Georgia, serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* ========== CUSTOM SCROLLBARS ========== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-elevated);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--gold-dark) 0%, var(--gold) 100%);
            border-radius: 4px;
            border: 2px solid var(--bg-elevated);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gold);
        }

        ::-webkit-scrollbar-corner {
            background: var(--bg-elevated);
        }

        /* Firefox */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--gold-dark) var(--bg-elevated);
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: var(--font-body);
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Subtle texture overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.02'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* ========== APP ========== */
        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* ========== VIEWS ========== */
        .views {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .view {
            position: absolute;
            inset: 0;
            padding: 32px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(16px);
            transition: all var(--transition);
        }

        .view.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* ========== NAVIGATION ========== */
        .nav {
            height: var(--nav-height);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 0 16px;
        }

        .nav-btn {
            flex: 1;
            max-width: 100px;
            height: 56px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-body);
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
        }

        .nav-btn svg {
            width: 22px;
            height: 22px;
            stroke-width: 1.5;
        }

        .nav-btn:hover {
            color: var(--text-dim);
            background: var(--bg-elevated);
        }

        .nav-btn.active {
            color: var(--gold);
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.08) 0%, transparent 100%);
        }

        /* ========== TRAIN VIEW ========== */
        .train-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            /* Changed from center to allow header */
            text-align: center;
            padding-top: 24px;
        }

        .train-header {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
            flex-shrink: 0;
        }

        .train-empty {
            max-width: 400px;
        }

        .train-empty-icon {
            width: 88px;
            height: 88px;
            margin: 0 auto 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-dark) 100%);
        }

        .train-empty-icon svg {
            width: 36px;
            height: 36px;
            color: var(--gold);
            stroke-width: 1.5;
        }

        .train-empty h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            margin-bottom: 12px;
            color: var(--gold-light);
        }

        .train-empty p {
            color: var(--text-dim);
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 32px;
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 32px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border: none;
            border-radius: 50px;
            color: var(--bg-dark);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-primary svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--gold-glow);
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            background: var(--bg-elevated);
            padding: 4px;
            border-radius: 50px;
            margin: 0 auto 32px;
            width: fit-content;
            border: 1px solid var(--border-subtle);
        }

        .mode-tab {
            padding: 8px 24px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            border-radius: 50px;
            transition: all var(--transition);
        }

        .mode-tab.active {
            background: var(--gold);
            color: var(--bg-dark);
        }

        .random-group {
            max-width: 320px;
            margin: 0 auto;
        }

        .random-input-wrap {
            position: relative;
            margin-bottom: 16px;
        }

        .random-input-wrap input {
            width: 100%;
            padding: 14px 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            color: var(--text);
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: all var(--transition);
        }

        .random-input-wrap input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 4px var(--gold-glow);
        }

        .rate-limit-msg {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .rate-limit-msg svg {
            width: 14px;
            height: 14px;
            color: var(--gold);
        }

        .train-active-actions {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            gap: 12px;
            z-index: 10;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition);
            backdrop-filter: blur(8px);
        }

        .action-btn:hover {
            color: var(--gold);
            border-color: var(--gold);
            transform: scale(1.1);
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Iframe styling for Map Mode */
        .train-iframe,
        .immersive-iframe {
            width: 100%;
            height: 100%;
            border: none;
            pointer-events: none;
            background: var(--bg-dark);
            border-radius: var(--radius);
        }

        .immersive-iframe {
            border-radius: 0;
        }

        .map-options {
            display: flex;
            gap: 12px;
            max-width: 320px;
            margin: 0 auto;
        }

        .map-select {
            flex: 1;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            color: var(--text);
            font-family: var(--font-body);
            cursor: pointer;
        }

        /* Animations */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spin {
            animation: spin 1s linear infinite;
        }

        .spinning svg {
            animation: spin 0.6s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        /* Training Active */
        .train-active {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .train-active.visible {
            display: flex;
        }

        .train-empty.hidden {
            display: none;
        }

        .train-content-area {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }

        .train-image-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            min-height: 0;
        }

        .train-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--radius);
            border: 1px solid var(--border-subtle);
            transition: transform var(--transition), box-shadow var(--transition);
        }

        .train-image-wrap:hover .train-image {
            transform: scale(1.01);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .train-tap-hint {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .train-tap-hint svg {
            width: 14px;
            height: 14px;
            color: var(--gold);
        }

        .train-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
            padding: 24px;
            margin-top: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
        }

        .train-stat {
            text-align: center;
        }

        .train-stat-value {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--gold);
        }

        .train-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        /* ========== GALLERY VIEW ========== */
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .gallery-header h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 500;
            color: var(--gold-light);
        }

        .gallery-count {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        .gallery-card {
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 1px solid var(--border-subtle);
            transition: all var(--transition);
        }

        .gallery-card:hover {
            transform: translateY(-4px);
            border-color: var(--gold);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 0 1px var(--gold-glow);
        }

        .gallery-card.selected {
            border-color: var(--gold);
            box-shadow: 0 0 0 2px var(--gold), 0 16px 48px rgba(0, 0, 0, 0.4);
        }

        .gallery-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, transparent 60%);
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .gallery-card:hover .gallery-card-overlay,
        .gallery-card.selected .gallery-card-overlay {
            opacity: 1;
        }

        .gallery-card-best {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gold);
        }

        .gallery-card-sessions {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .gallery-card-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-card-delete svg {
            width: 14px;
            height: 14px;
        }

        .gallery-card:hover .gallery-card-delete {
            opacity: 1;
        }

        .gallery-card-delete:hover {
            background: var(--danger);
            color: white;
        }

        .gallery-add {
            aspect-ratio: 1;
            border: 1px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--text-muted);
        }

        .gallery-add:hover {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(212, 175, 55, 0.03);
        }

        .gallery-add svg {
            width: 28px;
            height: 28px;
            stroke-width: 1.5;
        }

        .gallery-add span {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* ========== STATS VIEW ========== */
        .stats-header {
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .stats-header h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 500;
            color: var(--gold-light);
            margin-bottom: 4px;
        }

        .stats-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            transition: all var(--transition);
        }

        .stat-card:hover {
            border-color: var(--border);
        }

        .stat-card-value {
            font-family: var(--font-display);
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--gold);
        }

        .stat-card-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 8px;
        }

        .history-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .history-header h3 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--gold-light);
        }

        .history-filters {
            display: flex;
            gap: 8px;
        }

        .history-filters select {
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 0.8rem;
            font-family: var(--font-body);
        }

        /* History list with inset scrollbar */
        .history-list-wrapper {
            padding: 4px;
            background: var(--bg-card);
        }

        .history-list {
            max-height: 280px;
            overflow-y: auto;
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-subtle);
            transition: background var(--transition);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: var(--bg-elevated);
        }

        .history-item-time {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gold);
            min-width: 80px;
        }

        .history-item-date {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .history-item-note {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-item-delete svg {
            width: 16px;
            height: 16px;
        }

        .history-item-delete:hover {
            color: var(--danger);
        }

        .history-empty {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .history-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .history-pagination button {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition);
        }

        .history-pagination button:hover:not(:disabled) {
            border-color: var(--gold);
            color: var(--gold);
        }

        .history-pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .history-pagination span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* ========== IMMERSIVE MODE ========== */
        .immersive {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .immersive.active {
            display: flex;
        }

        .immersive::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.6) 100%);
            pointer-events: none;
        }

        .immersive-image {
            max-width: 90%;
            max-height: 75%;
            object-fit: contain;
            border-radius: var(--radius);
            transition: opacity 0.5s ease;
            z-index: 1;
        }

        .immersive-timer {
            position: absolute;
            top: 32px;
            right: 32px;
            font-family: var(--font-display);
            font-size: 2.8rem;
            font-weight: 500;
            color: var(--gold);
            text-shadow: 0 0 40px var(--gold-glow);
            z-index: 2;
        }

        .immersive-hint {
            position: absolute;
            bottom: 40px;
            font-size: 0.85rem;
            color: var(--text-muted);
            background: rgba(20, 20, 20, 0.8);
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid var(--border-subtle);
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .immersive-hint kbd {
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-family: var(--font-body);
            color: var(--gold);
            font-size: 0.8rem;
        }

        .immersive-close {
            position: absolute;
            top: 32px;
            left: 32px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .immersive-close svg {
            width: 20px;
            height: 20px;
        }

        .immersive-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: var(--text-muted);
        }

        /* ========== HELP MODAL (Dialog Box Style) ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            max-width: 480px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), 0 0 0 1px var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 500;
            color: var(--gold-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header h2 svg {
            width: 20px;
            height: 20px;
            color: var(--gold);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .modal-close svg {
            width: 18px;
            height: 18px;
        }

        .modal-close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.08);
        }

        /* Scrollable content wrapper - keeps scrollbar away from edge */
        .modal-body {
            flex: 1;
            overflow: hidden;
            padding: 4px;
        }

        .modal-scroll {
            height: 100%;
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
            border-radius: 8px;
        }

        .help-section {
            margin-bottom: 28px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section h3 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 500;
            color: var(--gold);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-section h3 svg {
            width: 18px;
            height: 18px;
        }

        .help-list {
            list-style: none;
        }

        .help-list li {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .help-list li:last-child {
            border-bottom: none;
        }

        .help-list kbd {
            min-width: 48px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            text-align: center;
            font-family: var(--font-body);
            font-size: 0.8rem;
            color: var(--gold);
        }

        /* ========== MOBILE ========== */
        @media (max-width: 600px) {
            .view {
                padding: 20px;
            }

            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .train-stats {
                gap: 24px;
                padding: 20px;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .history-filters {
                width: 100%;
                flex-wrap: wrap;
            }

            .history-item {
                flex-wrap: wrap;
                gap: 8px;
            }

            .immersive-timer {
                font-size: 2rem;
                top: 20px;
                right: 20px;
            }

            .immersive-close {
                top: 20px;
                left: 20px;
                width: 40px;
                height: 40px;
            }

            .train-empty h2 {
                font-size: 1.6rem;
            }

            .gallery-header h1,
            .stats-header h1 {
                font-size: 1.6rem;
            }
        }

        #file-input {
            display: none;
        }
    </style>
</head>

<body>
    <input type="file" id="file-input" accept="image/*">

    <div class="app">
        <div class="views">
            <!-- Train View -->
            <div class="view train-view active" id="train-view">
                <div class="train-header">
                    <div class="mode-tabs">
                        <button class="mode-tab active" data-mode="collection">Collection</button>
                        <button class="mode-tab" data-mode="random">Random Mode</button>
                        <button class="mode-tab" data-mode="map">Google Maps</button>
                    </div>
                </div>

                <div class="train-content-area">
                    <div class="train-empty" id="train-empty">
                        <div class="train-empty-icon">
                            <i data-lucide="eye"></i>
                        </div>

                        <div id="mode-collection-content">
                            <h2>Begin Your Practice</h2>
                            <p>Select an image from your collection to commence visualization training. Master the art
                                of
                                holding images in your mind's eye.</p>
                            <button class="btn-primary" id="go-gallery-btn-2">
                                <i data-lucide="image"></i>
                                View Collection
                            </button>
                        </div>

                        <div id="mode-random-content" style="display: none;">
                            <h2>Lorempiks Exploration</h2>
                            <p>Fetch random images. Supported categories: <b>food</b>, <b>nature</b>, <b>country</b>.
                            </p>
                            <div class="random-group">
                                <div class="random-input-wrap">
                                    <input type="text" id="random-q" placeholder="Category (food, nature, country)">
                                </div>
                                <button class="btn-primary" id="fetch-random-btn" style="width: 100%;">
                                    <i data-lucide="sparkles"></i>
                                    Start Random Practice
                                </button>
                            </div>
                            <div class="rate-limit-msg">
                                <i data-lucide="info"></i>
                                <span>Note: Invalid categories will return no image.</span>
                            </div>
                        </div>

                        <div id="mode-map-content" style="display: none;">
                            <h2>Global Street View</h2>
                            <p>Visualize curated global locations in first-person view. Static exploration.</p>
                            <div class="random-group">
                                <button class="btn-primary" id="fetch-map-btn" style="width: 100%;">
                                    <i data-lucide="map-pin"></i>
                                    Visit Random Location
                                </button>
                            </div>
                            <div class="rate-limit-msg">
                                <i data-lucide="info"></i>
                                <span>Static view enabled (no interaction)</span>
                            </div>
                        </div>
                    </div>

                    <div class="train-active" id="train-active">
                        <div class="train-image-wrap" id="train-image-wrap">
                            <div class="train-active-actions">
                                <button class="action-btn" id="stop-practice-btn" title="Exit practice">
                                    <i data-lucide="chevron-left"></i>
                                </button>
                                <button class="action-btn" id="refresh-random-btn" title="New random image"
                                    style="display: none;">
                                    <i data-lucide="refresh-cw"></i>
                                </button>
                            </div>
                            <img class="train-image" id="train-image" src="" alt="Training image">
                            <iframe class="train-iframe" id="train-iframe" style="display: none;"></iframe>
                            <div class="train-tap-hint">
                                <i data-lucide="maximize"></i>
                                Tap to enter focus mode
                            </div>
                        </div>
                        <div class="train-stats">
                            <div class="train-stat">
                                <div class="train-stat-value" id="train-best">0.00s</div>
                                <div class="train-stat-label">Personal Best</div>
                            </div>
                            <div class="train-stat">
                                <div class="train-stat-value" id="train-sessions">0</div>
                                <div class="train-stat-label">Sessions</div>
                            </div>
                            <div class="train-stat">
                                <div class="train-stat-value" id="train-total">0m</div>
                                <div class="train-stat-label">Total Time</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gallery View -->
            <div class="view" id="gallery-view">
                <div class="gallery-header">
                    <h1>Collection</h1>
                    <span class="gallery-count" id="gallery-count">0 images</span>
                </div>
                <div class="gallery-grid" id="gallery-grid"></div>
            </div>

            <!-- Stats View -->
            <div class="view" id="stats-view">
                <div class="stats-header">
                    <h1>Progress</h1>
                    <p>Your visualization journey at a glance</p>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-total-sessions">0</div>
                        <div class="stat-card-label">Total Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-total-time">0m</div>
                        <div class="stat-card-label">Time Invested</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-best-ever">0.00s</div>
                        <div class="stat-card-label">Best Record</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-images">0</div>
                        <div class="stat-card-label">In Collection</div>
                    </div>
                </div>

                <div class="history-section">
                    <div class="history-header">
                        <h3>Session History</h3>
                        <div class="history-filters">
                            <select id="filter-image">
                                <option value="">All Images</option>
                            </select>
                            <select id="filter-per-page">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    <div class="history-list-wrapper">
                        <div class="history-list" id="history-list"></div>
                    </div>
                    <div class="history-pagination">
                        <button id="prev-page"><i data-lucide="chevron-left"></i></button>
                        <span id="page-info">Page 1 of 1</span>
                        <button id="next-page"><i data-lucide="chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" data-view="train-view">
                <i data-lucide="target"></i>
                <span>Train</span>
            </button>
            <button class="nav-btn" data-view="gallery-view">
                <i data-lucide="layout-grid"></i>
                <span>Collection</span>
            </button>
            <button class="nav-btn" data-view="stats-view">
                <i data-lucide="bar-chart-2"></i>
                <span>Progress</span>
            </button>
            <button class="nav-btn" id="help-nav-btn">
                <i data-lucide="book-open"></i>
                <span>Guide</span>
            </button>
        </nav>
    </div>

    <!-- Immersive Mode -->
    <div class="immersive" id="immersive">
        <button class="immersive-close" id="immersive-close">
            <i data-lucide="x"></i>
        </button>
        <div class="immersive-timer" id="immersive-timer">0.00s</div>
        <img class="immersive-image" id="immersive-image" src="" alt="Focus image">
        <iframe class="immersive-iframe" id="immersive-iframe" style="display: none;"></iframe>
        <div class="immersive-hint">
            Hold <kbd>Space</kbd> to visualize
            <span>Â·</span>
            <kbd>Esc</kbd> to exit
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal">
            <div class="modal-header">
                <h2><i data-lucide="book-open"></i> Practitioner's Guide</h2>
                <button class="modal-close" id="help-close">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="modal-scroll">
                    <div class="help-section">
                        <h3><i data-lucide="target"></i> The Practice</h3>
                        <ul class="help-list">
                            <li>Add images to your collection</li>
                            <li>Select an image and enter focus mode</li>
                            <li>Study the image, then hold to hide it</li>
                            <li>Visualize in your mind as long as possible</li>
                            <li>Release to record your time</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h3><i data-lucide="keyboard"></i> Controls</h3>
                        <ul class="help-list">
                            <li><kbd>Space</kbd> Hold to visualize</li>
                            <li><kbd>Esc</kbd> Exit focus mode</li>
                            <li><kbd>1-4</kbd> Switch sections</li>
                            <li><kbd>?</kbd> Toggle this guide</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h3><i data-lucide="sparkles"></i> Advice</h3>
                        <ul class="help-list">
                            <li>Begin with simple images</li>
                            <li>Practice with consistency</li>
                            <li>Challenge your personal records</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ========== DOM ==========
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);

        const fileInput = $('file-input');
        const views = $$('.view');
        const navBtns = $$('.nav-btn[data-view]');
        const helpNavBtn = $('help-nav-btn');
        const trainEmpty = $('train-empty');
        const trainActive = $('train-active');
        const trainImage = $('train-image');
        const trainImageWrap = $('train-image-wrap');
        const trainBest = $('train-best');
        const trainSessions = $('train-sessions');
        const trainTotal = $('train-total');
        const goGalleryBtn = $('go-gallery-btn');
        const goGalleryBtn2 = $('go-gallery-btn-2');
        const galleryGrid = $('gallery-grid');
        const galleryCount = $('gallery-count');
        const statTotalSessions = $('stat-total-sessions');
        const statTotalTime = $('stat-total-time');
        const statBestEver = $('stat-best-ever');
        const statImages = $('stat-images');
        const filterImage = $('filter-image');
        const filterPerPage = $('filter-per-page');
        const historyList = $('history-list');
        const pageInfo = $('page-info');
        const prevPage = $('prev-page');
        const nextPage = $('next-page');
        const immersive = $('immersive');
        const immersiveImage = $('immersive-image');
        const immersiveTimer = $('immersive-timer');
        const immersiveClose = $('immersive-close');
        const helpModal = $('help-modal');
        const helpClose = $('help-close');

        // Random Mode Elements
        const modeTabs = $$('.mode-tab');
        const modeCollectionContent = $('mode-collection-content');
        const modeRandomContent = $('mode-random-content');
        const modeMapContent = $('mode-map-content');
        const trainIframe = $('train-iframe');
        const immersiveIframe = $('immersive-iframe');
        const randomQInput = $('random-q');
        const fetchRandomBtn = $('fetch-random-btn');
        const fetchMapBtn = $('fetch-map-btn');
        const refreshRandomBtn = $('refresh-random-btn');
        const stopPracticeBtn = $('stop-practice-btn');

        // ========== STATE ==========
        let images = [];
        let selectedImageId = null;
        let isRandomMode = false;
        let isMapMode = false;
        let lastRandomUrl = '';
        let currentRandomQ = '';
        let lastMapLocation = null;
        let isImmersive = false;
        let isVisualizing = false;
        let timerInterval = null;
        let seconds = 0;
        let historyPage = 1;
        let historyPerPage = 10;
        let historyImageFilter = '';


        // ========== STORAGE ==========
        const MAX_IMAGE_SIZE = 800; // Max dimension for stored images

        // Compress image to reduce storage size
        function compressImage(dataUrl, maxSize = MAX_IMAGE_SIZE) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let { width, height } = img;

                    // Only compress if larger than maxSize
                    if (width <= maxSize && height <= maxSize) {
                        resolve(dataUrl);
                        return;
                    }

                    // Calculate new dimensions
                    if (width > height) {
                        height = Math.round((height * maxSize) / width);
                        width = maxSize;
                    } else {
                        width = Math.round((width * maxSize) / height);
                        height = maxSize;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Use JPEG for better compression
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        // Get storage usage info
        function getStorageInfo() {
            let used = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    used += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
                }
            }
            return {
                used: used,
                usedMB: (used / 1024 / 1024).toFixed(2)
            };
        }

        const save = () => {
            try {
                localStorage.setItem('visutrain_data', JSON.stringify(images));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    const info = getStorageInfo();
                    alert(`Storage full (${info.usedMB}MB used). Please delete some images from your collection to continue saving.`);
                } else {
                    console.error('Save error:', e);
                }
            }
        };

        const load = () => {
            try {
                const data = localStorage.getItem('visualizationTrainerData') || localStorage.getItem('visutrain_data');
                if (data) {
                    images = JSON.parse(data).map(img => ({
                        ...img,
                        sessions: (img.sessions || []).map(s =>
                            typeof s === 'number'
                                ? { time: s, date: new Date().toISOString(), note: '' }
                                : { time: s.time || 0, date: s.date || new Date().toISOString(), note: s.note || '' }
                        )
                    }));

                    // Migrate old data key
                    if (localStorage.getItem('visualizationTrainerData')) {
                        localStorage.removeItem('visualizationTrainerData');
                        save();
                    }
                }
            } catch (e) {
                images = [];
            }
        };

        // ========== NAVIGATION ==========
        function switchView(viewId) {
            views.forEach(v => v.classList.remove('active'));
            $(viewId).classList.add('active');
            navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewId));

            if (viewId === 'gallery-view') renderGallery();
            if (viewId === 'stats-view') renderStats();
            if (viewId === 'train-view') renderTrain();
        }

        navBtns.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        if (goGalleryBtn) goGalleryBtn.addEventListener('click', () => switchView('gallery-view'));
        if (goGalleryBtn2) goGalleryBtn2.addEventListener('click', () => switchView('gallery-view'));

        // Mode Switching (Collection vs Random vs Map)
        modeTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const mode = tab.dataset.mode;
                isRandomMode = (mode === 'random');
                isMapMode = (mode === 'map');

                // Clear active states when switching modes
                selectedImageId = null;
                lastRandomUrl = '';
                lastMapLocation = null;

                renderTrain();

                // Update tab styles
                modeTabs.forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
            });
        });

        stopPracticeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            selectedImageId = null;
            lastRandomUrl = '';
            lastMapLocation = null;
            renderTrain();
        });

        // ========== GALLERY ==========
        function renderGallery() {
            galleryGrid.innerHTML = '';

            const addCard = document.createElement('div');
            addCard.className = 'gallery-add';
            addCard.innerHTML = '<i data-lucide="plus"></i><span>Add Image</span>';
            addCard.addEventListener('click', () => fileInput.click());
            galleryGrid.appendChild(addCard);

            images.forEach(img => {
                if (img.id.startsWith('random_')) return; // Don't show random mode "sessions" in gallery

                const card = document.createElement('div');
                card.className = 'gallery-card' + (img.id === selectedImageId ? ' selected' : '');
                card.innerHTML = `
                    <img src="${img.src}" alt="Gallery image">
                    <div class="gallery-card-overlay">
                        <div class="gallery-card-best">${(img.highScore || 0).toFixed(2)}s</div>
                        <div class="gallery-card-sessions">${(img.sessions || []).length} sessions</div>
                    </div>
                    <button class="gallery-card-delete"><i data-lucide="trash-2"></i></button>
                `;

                card.addEventListener('click', e => {
                    if (e.target.closest('.gallery-card-delete')) {
                        e.stopPropagation();
                        if (confirm('Remove this image from your collection?')) {
                            images = images.filter(i => i.id !== img.id);
                            if (selectedImageId === img.id) selectedImageId = null;
                            save();
                            renderGallery();
                            renderTrain();
                        }
                        return;
                    }
                    selectedImageId = img.id;
                    isRandomMode = false;
                    save();
                    renderGallery();
                    switchView('train-view');
                });

                galleryGrid.appendChild(card);
            });

            galleryCount.textContent = `${images.length} image${images.length !== 1 ? 's' : ''}`;
            lucide.createIcons();
        }

        // ========== FILE UPLOAD ==========
        fileInput.addEventListener('change', async e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async ev => {
                // Compress image before storing
                const compressedSrc = await compressImage(ev.target.result);

                const newImg = {
                    id: `img_${Date.now()}`,
                    src: compressedSrc,
                    sessions: [],
                    highScore: 0
                };
                images.push(newImg);
                selectedImageId = newImg.id;
                save();
                renderGallery();
                switchView('train-view');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        // ========== TRAIN VIEW ==========
        function renderTrain() {
            let img;
            let isAnyActive = false;

            if (isRandomMode && lastRandomUrl) {
                isAnyActive = true;
                img = { src: lastRandomUrl, isRandom: true };
            } else if (isMapMode && lastMapLocation) {
                isAnyActive = true;
                img = { isMap: true };
            } else if (!isRandomMode && !isMapMode && selectedImageId) {
                isAnyActive = true;
                img = images.find(i => i.id === selectedImageId);
            }

            // Sync mode tabs
            const currentMode = isRandomMode ? 'random' : (isMapMode ? 'map' : 'collection');
            modeTabs.forEach(t => t.classList.toggle('active', t.dataset.mode === currentMode));

            if (!isAnyActive) {
                trainEmpty.classList.remove('hidden');
                trainActive.classList.remove('visible');

                modeCollectionContent.style.display = 'none';
                modeRandomContent.style.display = 'none';
                modeMapContent.style.display = 'none';

                if (isRandomMode) modeRandomContent.style.display = 'block';
                else if (isMapMode) modeMapContent.style.display = 'block';
                else modeCollectionContent.style.display = 'block';
                return;
            }

            trainEmpty.classList.add('hidden');
            trainActive.classList.add('visible');

            if (isMapMode) {
                trainImage.style.display = 'none';
                trainIframe.style.display = 'block';
                immersiveImage.style.display = 'none';
                immersiveIframe.style.display = 'block';

                const mapUrl = `https://maps.google.com/maps?layer=c&cbll=${lastMapLocation.lat},${lastMapLocation.lng}&cbp=11,${lastMapLocation.heading},0,0,0&output=svembed`;
                trainIframe.src = mapUrl;
                immersiveIframe.src = mapUrl;

                refreshRandomBtn.style.display = 'flex';

                // Stats for Map Mode
                const allMapSessions = [];
                images.forEach(i => {
                    if (i.id.startsWith('map_')) {
                        allMapSessions.push(...(i.sessions || []));
                    }
                });
                const best = allMapSessions.length ? Math.max(...allMapSessions.map(s => s.time)) : 0;
                const totalSec = allMapSessions.reduce((sum, s) => sum + s.time, 0);

                trainBest.textContent = `${best.toFixed(2)}s`;
                trainSessions.textContent = allMapSessions.length;
                trainTotal.textContent = formatTime(totalSec);
            } else {
                trainIframe.style.display = 'none';
                trainImage.style.display = 'block';
                immersiveIframe.style.display = 'none';
                immersiveImage.style.display = 'block';

                const src = isRandomMode ? lastRandomUrl : img.src;
                trainImage.src = src;
                immersiveImage.src = src;

                if (isRandomMode) {
                    refreshRandomBtn.style.display = 'flex';
                    const allRandomSessions = [];
                    images.forEach(i => {
                        if (i.id.startsWith('random_')) {
                            allRandomSessions.push(...(i.sessions || []));
                        }
                    });
                    const best = allRandomSessions.length ? Math.max(...allRandomSessions.map(s => s.time)) : 0;
                    const totalSec = allRandomSessions.reduce((sum, s) => sum + s.time, 0);

                    trainBest.textContent = `${best.toFixed(2)}s`;
                    trainSessions.textContent = allRandomSessions.length;
                    trainTotal.textContent = formatTime(totalSec);
                } else {
                    refreshRandomBtn.style.display = 'none';
                    trainBest.textContent = `${(img.highScore || 0).toFixed(2)}s`;
                    trainSessions.textContent = (img.sessions || []).length;
                    const totalSec = (img.sessions || []).reduce((sum, s) => sum + s.time, 0);
                    trainTotal.textContent = formatTime(totalSec);
                }
            }
        }

        async function fetchRandomImage(category = '') {
            const validCategories = ['food', 'nature', 'country'];
            currentRandomQ = category.trim().toLowerCase();

            if (!validCategories.includes(currentRandomQ)) {
                currentRandomQ = 'nature'; // Default fallback
            }

            // Simple URL with cache buster to force a new random image
            const url = `https://lorempiks.netlify.app/api/${currentRandomQ}?_=${Date.now()}`;

            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    // Direct assignment to bypass CORS fetch errors
                    lastRandomUrl = url;
                    isRandomMode = true;
                    selectedImageId = null;
                    resolve();
                };
                img.onerror = () => {
                    console.error("Lorempiks Image Load Error");
                    reject('Could not load image');
                };
                img.src = url;
            });
        }

        // ========== MAP LOGIC ==========
        const streetViewLocations = [
            // Original User Locations
            // Urban / Landmarks (kept for completeness, though focus is nature)
            { name: 'Eiffel Tower, Paris', lat: 48.858370, lng: 2.294481, heading: 0 },
            { name: 'Times Square, NYC', lat: 40.758896, lng: -73.985130, heading: 25 },
            { name: 'Santorini, Greece', lat: 36.461875, lng: 25.375681, heading: 180 },
            { name: 'Venice Canals', lat: 45.433890, lng: 12.339241, heading: 60 },
            { name: 'Taj Mahal, India', lat: 27.175015, lng: 78.042155, heading: 0 },
            { name: 'Opera House, Sydney', lat: -33.856784, lng: 151.215297, heading: 340 },
            { name: 'Petra, Jordan', lat: 30.328454, lng: 35.444362, heading: 270 },
            { name: 'Burj Khalifa, Dubai', lat: 25.197197, lng: 55.274376, heading: 45 },
            { name: 'Colosseum, Rome', lat: 41.890210, lng: 12.492231, heading: 310 },
            { name: 'Christ the Redeemer', lat: -22.951916, lng: -43.210487, heading: 150 },
            { name: 'Hallstatt, Austria', lat: 47.562218, lng: 13.649206, heading: 190 },

            // Nature - Mountains & Canyons
            { name: 'Grand Canyon, USA', lat: 36.056024, lng: -112.109605, heading: 320 },
            { name: 'Swiss Alps (Zermatt)', lat: 46.020713, lng: 7.749117, heading: 150 },
            { name: 'Machu Picchu', lat: -13.163141, lng: -72.544963, heading: 120 },
            { name: 'Mount Fuji, Japan', lat: 35.360625, lng: 138.727363, heading: 240 },
            { name: 'Banff National Park', lat: 51.178430, lng: -115.570769, heading: 200 },
            { name: 'Everest Base Camp', lat: 28.0026, lng: 86.8527, heading: 90 },
            { name: 'Yosemite (Tunnel View)', lat: 37.7157, lng: -119.6775, heading: 85 },
            { name: 'Dolomites, Italy', lat: 46.6083, lng: 12.0622, heading: 180 },
            { name: 'Torres del Paine, Chile', lat: -50.9423, lng: -73.4068, heading: 270 },
            { name: 'Vinicunca (Rainbow Mtn)', lat: -13.8694, lng: -71.3030, heading: 90 },
            { name: 'Kirkjufell, Iceland', lat: 64.9416, lng: -23.3069, heading: 240 },

            // Nature - Water & Coasts
            { name: 'Great Barrier Reef', lat: -23.442896, lng: 151.906584, heading: 0 },
            { name: 'Milford Sound, NZ', lat: -44.6414, lng: 167.8974, heading: 300 },
            { name: 'Ha Long Bay, Vietnam', lat: 20.9101, lng: 107.1839, heading: 120 },
            { name: 'Bora Bora, French Polynesia', lat: -16.5004, lng: -151.7415, heading: 45 },
            { name: 'Maldives (Overwater)', lat: 4.1755, lng: 73.5093, heading: 180 },
            { name: 'Lake Louise, Canada', lat: 51.4170, lng: -116.2269, heading: 210 },
            { name: 'Plitvice Lakes, Croatia', lat: 44.8805, lng: 15.6161, heading: 30 },
            { name: 'Twelve Apostles, Australia', lat: -38.6646, lng: 143.1030, heading: 270 },
            { name: 'Geirangerfjord, Norway', lat: 62.1008, lng: 7.2059, heading: 250 },
            { name: 'Iguazu Falls', lat: -25.6953, lng: -54.4367, heading: 270 },
            { name: 'Victoria Falls', lat: -17.9243, lng: 25.8559, heading: 90 },

            // Nature - Forests & Greenery
            { name: 'Amazon Rainforest', lat: -3.1098, lng: -60.0240, heading: 0 },
            { name: 'Redwood National Park', lat: 41.2132, lng: -124.0046, heading: 0 },
            { name: 'Kyoto Bamboo Grove', lat: 35.016840, lng: 135.671407, heading: 270 },
            { name: 'Crooked Forest, Poland', lat: 53.2139, lng: 14.4752, heading: 0 },
            { name: 'Jeju Island, Korea', lat: 33.4996, lng: 126.5312, heading: 180 },

            // Nature - Desert & Extremes
            { name: 'Sahara Desert (Merzouga)', lat: 31.0802, lng: -4.0133, heading: 90 },
            { name: 'Salar de Uyuni, Bolivia', lat: -20.1338, lng: -67.4891, heading: 45 },
            { name: 'Wadi Rum, Jordan', lat: 29.5638, lng: 35.4245, heading: 120 },
            { name: 'Antarctica', lat: -64.7314, lng: -62.6074, heading: 180 },
            { name: 'Death Valley, USA', lat: 36.2419, lng: -116.8258, heading: 300 },

            // Phenomena & Unique
            { name: 'Aurora Borealis (Alaska)', lat: 64.8378, lng: -147.7164, heading: 0 },
            { name: 'Iceland (Ring Road)', lat: 63.532052, lng: -19.511370, heading: 90 },

            // Additional from Previous Response
            { name: 'Matterhorn, Swiss Alps', lat: 45.9766, lng: 7.6585, heading: 180 },
            { name: 'Mont Blanc View', lat: 45.8326, lng: 6.8652, heading: 90 },
            { name: 'Zion Canyon, Utah', lat: 37.2982, lng: -113.0288, heading: 0 },
            { name: 'Bryce Canyon Hoodoos', lat: 37.6283, lng: -112.1676, heading: 270 },
            { name: 'Antelope Canyon', lat: 36.8619, lng: -111.3762, heading: 120 },
            { name: 'Arches National Park (Delicate Arch View)', lat: 38.7436, lng: -109.4993, heading: 150 },
            { name: 'Glacier National Park (Going-to-the-Sun Road)', lat: 48.7596, lng: -113.7870, heading: 200 },
            { name: 'Rocky Mountain National Park (Trail Ridge Road)', lat: 40.4000, lng: -105.8000, heading: 45 },
            { name: 'Denali National Park View', lat: 63.3331, lng: -150.5000, heading: 180 },
            { name: 'Haleakala Crater, Hawaii', lat: 20.7097, lng: -156.1699, heading: 90 },
            { name: 'Niagara Falls (American Side)', lat: 43.0828, lng: -79.0742, heading: 270 },
            { name: 'Multnomah Falls, Oregon', lat: 45.5761, lng: -122.1154, heading: 180 },
            { name: 'Lower Yosemite Falls', lat: 37.7450, lng: -119.5960, heading: 0 },
            { name: 'Havasu Falls Area', lat: 36.2550, lng: -112.6975, heading: 120 },
            { name: 'Emerald Lake, Yoho NP, Canada', lat: 51.4432, lng: -116.5460, heading: 210 },
            { name: 'Moraine Lake, Banff', lat: 51.3219, lng: -116.1863, heading: 150 },
            { name: 'Peyto Lake, Banff', lat: 51.7107, lng: -116.5223, heading: 300 },
            { name: 'Crater Lake, Oregon', lat: 42.9446, lng: -122.1090, heading: 45 },
            { name: 'Niagara-on-the-Lake View', lat: 43.2553, lng: -79.0719, heading: 90 },
            { name: 'Seljalandsfoss, Iceland', lat: 63.6156, lng: -19.9886, heading: 270 },
            { name: 'Na Pali Coast, Kauai', lat: 22.1750, lng: -159.6500, heading: 180 },
            { name: 'Big Sur, California (Bixby Bridge)', lat: 36.3714, lng: -121.9022, heading: 0 },
            { name: 'Amalfi Coast, Italy', lat: 40.6333, lng: 14.6027, heading: 120 },
            { name: 'Cliffs of Moher, Ireland', lat: 52.9713, lng: -9.4309, heading: 270 },
            { name: 'Great Ocean Road (Twelve Apostles View)', lat: -38.6640, lng: 143.1045, heading: 180 },
            { name: 'Sognefjord, Norway', lat: 61.1000, lng: 6.8000, heading: 90 },
            { name: 'Cinque Terre, Italy', lat: 44.1270, lng: 9.7092, heading: 45 },
            { name: 'Sequoia National Park (Giant Forest)', lat: 36.5649, lng: -118.7730, heading: 0 },
            { name: 'Black Forest, Germany', lat: 48.3000, lng: 8.1500, heading: 180 },
            { name: 'Arashiyama Bamboo Forest (near entrance)', lat: 35.0170, lng: 135.6725, heading: 270 },
            { name: 'Avenue of the Baobabs, Madagascar', lat: -20.2500, lng: 44.4180, heading: 90 },
            { name: 'Yakushima Forest, Japan', lat: 30.3460, lng: 130.5260, heading: 120 },
            { name: 'Namib Desert Dunes', lat: -24.7333, lng: 15.2833, heading: 180 },
            { name: 'Atacama Desert', lat: -23.8500, lng: -69.2000, heading: 0 },
            { name: 'Monument Valley', lat: 37.0042, lng: -110.1735, heading: 270 },
            { name: 'Cappadocia Balloons View', lat: 38.6430, lng: 34.8290, heading: 90 },
            { name: 'Zhangjiajie National Forest Park', lat: 29.1171, lng: 110.4790, heading: 180 },
            { name: 'Banff Gondola View (Sulphur Mountain)', lat: 51.1460, lng: -115.5730, heading: 200 },
            { name: 'Angel Falls Approach', lat: 5.9700, lng: -62.5360, heading: 45 },
            { name: 'Pamukkale Travertines, Turkey', lat: 37.9230, lng: 29.1230, heading: 120 },
            { name: 'Yellowstone Grand Prismatic Spring', lat: 44.5250, lng: -110.8380, heading: 270 },
            { name: 'Jiuzhaigou Valley, China', lat: 33.2000, lng: 103.9000, heading: 90 },
            { name: 'Trolltunga, Norway', lat: 60.1333, lng: 6.7333, heading: 180 },
            { name: 'Preikestolen (Pulpit Rock), Norway', lat: 58.9871, lng: 6.1887, heading: 0 },
            { name: 'Table Mountain, Cape Town', lat: -33.9628, lng: 18.4098, heading: 270 },
            { name: 'Patagonia (Fitz Roy View)', lat: -49.2750, lng: -73.0000, heading: 90 },
            { name: 'Northern Lights Spot (TromsÃ¸ area)', lat: 69.6500, lng: 18.9500, heading: 0 },
            { name: 'Swiss Interlaken Lakes', lat: 46.6863, lng: 7.8632, heading: 180 },
            { name: 'Scottish Highlands (Glencoe)', lat: 56.6690, lng: -5.1000, heading: 120 },
            { name: 'New Zealand Fiordland', lat: -45.4000, lng: 167.7000, heading: 300 },
            { name: 'Alaskan Glacier Bay', lat: 58.5000, lng: -136.0000, heading: 45 },
            { name: 'Himalayan Views (Annapurna)', lat: 28.6000, lng: 83.8200, heading: 270 },
            { name: 'Yellowstone Old Faithful Area', lat: 44.4605, lng: -110.8281, heading: 180 },
            { name: 'Grand Teton Oxbow Bend', lat: 43.8600, lng: -110.5470, heading: 90 },
            { name: 'Shenandoah Skyline Drive Overlook', lat: 38.6000, lng: -78.3500, heading: 0 },
            { name: 'Acadia National Park (Cadillac Mountain)', lat: 44.3540, lng: -68.2250, heading: 270 },
            { name: 'Olympic National Park (Hoh Rain Forest)', lat: 47.8600, lng: -123.9300, heading: 120 },
            { name: 'Great Smoky Mountains (Clingmans Dome View)', lat: 35.5629, lng: -83.4984, heading: 180 },
            { name: 'Joshua Tree National Park', lat: 33.8734, lng: -115.9010, heading: 45 },
            { name: 'Death Valley Badwater Basin', lat: 36.2300, lng: -116.8250, heading: 90 },
            { name: 'Everglades Anhinga Trail', lat: 25.3810, lng: -80.6090, heading: 270 },
            { name: 'Mesa Verde Cliff Dwellings View', lat: 37.2300, lng: -108.4600, heading: 0 },
            { name: 'Mount Kilimanjaro View', lat: -3.0674, lng: 37.3556, heading: 180 },
            { name: 'Serengeti Plains', lat: -2.3333, lng: 34.8333, heading: 90 },
            { name: 'Okavango Delta', lat: -19.2833, lng: 22.9167, heading: 270 },
            { name: 'Galapagos Islands (Bartolome)', lat: -0.2833, lng: -90.5500, heading: 120 },
            { name: 'Amazon River View', lat: -3.4653, lng: -58.3800, heading: 0 },
            { name: 'Great Wall in Mountains', lat: 40.4319, lng: 116.5704, heading: 180 },
            { name: 'Petra Treasury View', lat: 30.3222, lng: 35.4517, heading: 90 },
            { name: 'Pyramids of Giza Desert', lat: 29.9792, lng: 31.1342, heading: 270 },
            { name: 'Ring Road Iceland (Black Sand Beach)', lat: 63.4160, lng: -19.0100, heading: 180 },
            { name: 'Dolomites Pass', lat: 46.5000, lng: 11.8000, heading: 0 },
            { name: 'Norwegian Atlantic Road', lat: 63.0167, lng: 7.3500, heading: 90 },
            { name: 'Garden Route, South Africa', lat: -34.0000, lng: 23.0000, heading: 270 },
            { name: 'Tuscany Hills', lat: 43.4667, lng: 11.1667, heading: 120 },
            { name: 'Dead Sea View', lat: 31.5000, lng: 35.5000, heading: 180 },
            { name: 'Aurora Spot Finland', lat: 66.5000, lng: 25.7333, heading: 0 },
            { name: 'Cherry Blossom Kyoto', lat: 35.0000, lng: 135.7500, heading: 270 },
            { name: 'Lavender Fields Provence', lat: 43.9000, lng: 5.4000, heading: 90 },
            { name: 'Tulip Fields Netherlands', lat: 52.3000, lng: 4.8000, heading: 180 },

            // Additional Japan Nature Locations
            { name: 'Mount Fuji Summit Trail', lat: 35.3609, lng: 138.7278, heading: 180 }, // Yoshida Trail area
            { name: 'Arashiyama Bamboo Grove, Kyoto', lat: 35.0171, lng: 135.6728, heading: 0 },
            { name: 'Oirase Gorge Stream, Aomori', lat: 40.6000, lng: 140.9500, heading: 90 },
            { name: 'Shiretoko Five Lakes, Hokkaido', lat: 44.1000, lng: 145.1000, heading: 180 },
            { name: 'Lake Chuzenji, Nikko', lat: 36.7400, lng: 139.4800, heading: 270 },
            { name: 'Takachiho Gorge, Miyazaki', lat: 32.7000, lng: 131.3000, heading: 120 },
            { name: 'Yakushima Ancient Cedars', lat: 30.3500, lng: 130.5200, heading: 45 },
            { name: 'Shirakami Sanchi Beech Forest', lat: 40.4700, lng: 140.1300, heading: 0 },
            { name: 'Kamikochi Valley, Japanese Alps', lat: 36.2500, lng: 137.6300, heading: 200 },
            { name: 'Hakone Lake Ashi View', lat: 35.2000, lng: 139.0300, heading: 150 },

            // Additional China Nature Locations (limited Street View, but scenic spots)
            { name: 'Huangshan (Yellow Mountain) Summit', lat: 30.1300, lng: 118.1700, heading: 90 },
            { name: 'Zhangjiajie Avatar Hallelujah Mountain', lat: 29.3300, lng: 110.4400, heading: 180 },
            { name: 'Li River Karsts, Yangshuo', lat: 24.7800, lng: 110.5000, heading: 270 },
            { name: 'Nine Bend River, Wuyishan', lat: 27.7300, lng: 118.0000, heading: 0 }
        ];
        function generateRandomMap() {
            const loc = streetViewLocations[Math.floor(Math.random() * streetViewLocations.length)];

            lastMapLocation = {
                lat: loc.lat,
                lng: loc.lng,
                heading: loc.heading,
                region: loc.name,
                zoom: 0
            };
            isMapMode = true;
            isRandomMode = false;
            selectedImageId = null;
        }

        fetchRandomBtn.addEventListener('click', async () => {
            const q = randomQInput.value.trim();
            fetchRandomBtn.disabled = true;
            fetchRandomBtn.innerHTML = '<i data-lucide="loader-2" class="spin"></i> Fetching...';
            lucide.createIcons();

            try {
                await fetchRandomImage(q);
                renderTrain();
            } catch (err) {
                alert('Could not fetch random image. Please try again or check your connection.');
            } finally {
                fetchRandomBtn.disabled = false;
                fetchRandomBtn.innerHTML = '<i data-lucide="sparkles"></i> Start Random Practice';
                lucide.createIcons();
            }
        });

        fetchMapBtn.addEventListener('click', () => {
            generateRandomMap();
            renderTrain();
        });

        refreshRandomBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            refreshRandomBtn.classList.add('spinning');
            try {
                if (isRandomMode) {
                    await fetchRandomImage(currentRandomQ);
                } else if (isMapMode) {
                    generateRandomMap();
                }
                renderTrain();
            } catch (err) {
                alert('Failed to refresh.');
            } finally {
                setTimeout(() => refreshRandomBtn.classList.remove('spinning'), 500);
            }
        });

        trainImageWrap.addEventListener('click', () => {
            if (selectedImageId || isRandomMode || isMapMode) enterImmersive();
        });

        function formatTime(sec) {
            if (sec < 60) return `${sec.toFixed(0)}s`;
            if (sec < 3600) return `${(sec / 60).toFixed(1)}m`;
            return `${(sec / 3600).toFixed(1)}h`;
        }


        // ========== IMMERSIVE MODE ==========
        async function enterImmersive() {
            isImmersive = true;
            immersive.classList.add('active');

            if (isMapMode) {
                immersiveIframe.style.opacity = '1';
                immersiveImage.style.display = 'none';
                immersiveIframe.style.display = 'block';
            } else {
                immersiveImage.style.opacity = '1';
                immersiveImage.style.display = 'block';
                immersiveIframe.style.display = 'none';
            }

            immersiveTimer.textContent = '0.00s';

            try {
                if (immersive.requestFullscreen) {
                    await immersive.requestFullscreen();
                } else if (immersive.webkitRequestFullscreen) {
                    await immersive.webkitRequestFullscreen();
                }
            } catch (e) { }
        }

        async function exitImmersive() {
            if (isVisualizing) stopVisualize();
            isImmersive = false;
            immersive.classList.remove('active');

            try {
                if (document.fullscreenElement) {
                    await document.exitFullscreen();
                } else if (document.webkitFullscreenElement) {
                    await document.webkitExitFullscreen();
                }
            } catch (e) { }
        }

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isImmersive) {
                isImmersive = false;
                immersive.classList.remove('active');
                if (isVisualizing) stopVisualize();
            }
        });

        immersiveClose.addEventListener('click', exitImmersive);


        // ========== VISUALIZATION ==========
        function startVisualize() {
            if ((!selectedImageId && !isRandomMode && !isMapMode) || isVisualizing) return;

            isVisualizing = true;
            seconds = 0;
            const start = Date.now();

            if (isMapMode) immersiveIframe.style.opacity = '0';
            else immersiveImage.style.opacity = '0';

            timerInterval = setInterval(() => {
                seconds = (Date.now() - start) / 1000;
                immersiveTimer.textContent = `${seconds.toFixed(2)}s`;
            }, 16);
        }

        function stopVisualize() {
            if (!timerInterval) return;

            clearInterval(timerInterval);
            timerInterval = null;
            isVisualizing = false;

            if (isMapMode) immersiveIframe.style.opacity = '1';
            else immersiveImage.style.opacity = '1';

            if (seconds > 0.2) {
                let img;
                if (isRandomMode) {
                    // Store random mode sessions in a special "virtual" image record
                    const randomId = `random_${currentRandomQ || 'any'}`;
                    img = images.find(i => i.id === randomId);
                    if (!img) {
                        img = {
                            id: randomId,
                            src: lastRandomUrl,
                            sessions: [],
                            highScore: 0,
                            isRandom: true
                        };
                        images.push(img);
                    }
                    img.src = lastRandomUrl;
                } else if (isMapMode) {
                    const mapId = `map_${lastMapLocation.region}`;
                    img = images.find(i => i.id === mapId);
                    if (!img) {
                        img = {
                            id: mapId,
                            src: '', // Placeholder for maps in gallery if we showed them
                            sessions: [],
                            highScore: 0,
                            isMap: true
                        };
                        images.push(img);
                    }
                } else {
                    img = images.find(i => i.id === selectedImageId);
                }

                if (img) {
                    img.sessions.unshift({
                        time: seconds,
                        date: new Date().toISOString(),
                        note: isMapMode ? `Map: ${lastMapLocation.region}` : (isRandomMode ? `Random: ${currentRandomQ || 'General'}` : '')
                    });
                    if (seconds > img.highScore) img.highScore = seconds;
                    save();
                    renderTrain();
                }
            }
        }

        let touchStarted = false;

        immersive.addEventListener('mousedown', e => {
            if (e.target !== immersiveClose && !e.target.closest('.immersive-close') && isImmersive) startVisualize();
        });

        immersive.addEventListener('mouseup', () => { if (isVisualizing) stopVisualize(); });

        immersive.addEventListener('touchstart', e => {
            if (e.target !== immersiveClose && !e.target.closest('.immersive-close') && isImmersive) {
                touchStarted = true;
                startVisualize();
            }
        }, { passive: true });

        immersive.addEventListener('touchend', () => {
            if (touchStarted && isVisualizing) stopVisualize();
            touchStarted = false;
        });

        // ========== STATS VIEW ==========
        function renderStats() {
            let totalSessions = 0, totalTime = 0, bestEver = 0;

            images.forEach(img => {
                (img.sessions || []).forEach(s => {
                    totalSessions++;
                    totalTime += s.time;
                    if (s.time > bestEver) bestEver = s.time;
                });
            });

            statTotalSessions.textContent = totalSessions;
            statTotalTime.textContent = formatTime(totalTime);
            statBestEver.textContent = `${bestEver.toFixed(2)}s`;
            statImages.textContent = images.length;

            filterImage.innerHTML = '<option value="">All Images</option>';
            images.forEach((img, i) => {
                filterImage.innerHTML += `<option value="${img.id}">Image ${i + 1}</option>`;
            });
            filterImage.value = historyImageFilter;

            renderHistory();
        }

        function renderHistory() {
            let allSessions = [];

            images.forEach(img => {
                if (historyImageFilter && img.id !== historyImageFilter) return;
                (img.sessions || []).forEach(s => {
                    allSessions.push({ ...s, imageId: img.id });
                });
            });

            allSessions.sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalPages = Math.ceil(allSessions.length / historyPerPage) || 1;
            historyPage = Math.max(1, Math.min(historyPage, totalPages));

            const start = (historyPage - 1) * historyPerPage;
            const paginated = allSessions.slice(start, start + historyPerPage);

            if (paginated.length === 0) {
                historyList.innerHTML = '<div class="history-empty">No sessions recorded yet</div>';
            } else {
                historyList.innerHTML = paginated.map(s => `
                    <div class="history-item" data-date="${s.date}" data-image="${s.imageId}">
                        <span class="history-item-time">${s.time.toFixed(2)}s</span>
                        <span class="history-item-date">${new Date(s.date).toLocaleString()}</span>
                        <span class="history-item-note">${s.note || 'â'}</span>
                        <button class="history-item-delete"><i data-lucide="x"></i></button>
                    </div>
                `).join('');
            }

            pageInfo.textContent = `Page ${historyPage} of ${totalPages}`;
            prevPage.disabled = historyPage <= 1;
            nextPage.disabled = historyPage >= totalPages;

            lucide.createIcons();
        }

        historyList.addEventListener('click', e => {
            if (e.target.closest('.history-item-delete')) {
                const item = e.target.closest('.history-item');
                const date = item.dataset.date;
                const imageId = item.dataset.image;

                const img = images.find(i => i.id === imageId);
                if (img) {
                    img.sessions = img.sessions.filter(s => s.date !== date);
                    img.highScore = Math.max(0, ...img.sessions.map(s => s.time), 0);
                    save();
                    renderStats();
                    renderTrain();
                }
            }
        });

        filterImage.addEventListener('change', () => {
            historyImageFilter = filterImage.value;
            historyPage = 1;
            renderHistory();
        });

        filterPerPage.addEventListener('change', () => {
            historyPerPage = parseInt(filterPerPage.value);
            historyPage = 1;
            renderHistory();
        });

        prevPage.addEventListener('click', () => { if (historyPage > 1) { historyPage--; renderHistory(); } });
        nextPage.addEventListener('click', () => { historyPage++; renderHistory(); });

        // ========== HELP ==========
        function toggleHelp(show) { helpModal.classList.toggle('active', show); }

        helpNavBtn.addEventListener('click', () => toggleHelp(true));
        helpClose.addEventListener('click', () => toggleHelp(false));
        helpModal.addEventListener('click', e => { if (e.target === helpModal) toggleHelp(false); });

        // ========== KEYBOARD ==========
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    if (isImmersive && !isVisualizing) startVisualize();
                    else if ((selectedImageId || isRandomMode || isMapMode) && !isImmersive) enterImmersive();
                    break;
                case 'Escape':
                    if (helpModal.classList.contains('active')) toggleHelp(false);
                    else if (isImmersive) exitImmersive();
                    break;
                case '1': switchView('train-view'); break;
                case '2': switchView('gallery-view'); break;
                case '3': switchView('stats-view'); break;
                case '4':
                case '?': toggleHelp(!helpModal.classList.contains('active')); break;
            }
        });

        document.addEventListener('keyup', e => {
            if (e.key === ' ' && isVisualizing) stopVisualize();
        });

        // ========== INIT ==========
        load();
        if (images.length > 0 && !selectedImageId) selectedImageId = images[0].id;
        renderTrain();
        renderGallery();
    </script>
</body>

</html>
