<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VisuTrain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-dark: #0c0c0c;
            --bg-card: #141414;
            --bg-elevated: #1a1a1a;
            --gold: #d4af37;
            --gold-light: #f4e4a6;
            --gold-dark: #a68b2a;
            --gold-glow: rgba(212, 175, 55, 0.25);
            --text: #f5f5f5;
            --text-dim: #a0a0a0;
            --text-muted: #666;
            --border: rgba(212, 175, 55, 0.15);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --danger: #c94040;
            --radius: 12px;
            --radius-sm: 8px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --nav-height: 72px;
            --font-display: 'Cormorant Garamond', Georgia, serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            background: var(--bg-dark);
            font-family: var(--font-body);
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Subtle texture overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.02'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* ========== APP ========== */
        .app {
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* ========== VIEWS ========== */
        .views {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .view {
            position: absolute;
            inset: 0;
            padding: 32px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(16px);
            transition: all var(--transition);
        }

        .view.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* ========== NAVIGATION ========== */
        .nav {
            height: var(--nav-height);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 0 16px;
        }

        .nav-btn {
            flex: 1;
            max-width: 100px;
            height: 56px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-body);
            font-size: 0.7rem;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-radius: var(--radius-sm);
            margin: 8px 0;
        }

        .nav-btn svg {
            width: 22px;
            height: 22px;
            stroke-width: 1.5;
        }

        .nav-btn:hover {
            color: var(--text-dim);
            background: var(--bg-elevated);
        }

        .nav-btn.active {
            color: var(--gold);
            background: linear-gradient(180deg, rgba(212, 175, 55, 0.08) 0%, transparent 100%);
        }

        /* ========== TRAIN VIEW ========== */
        .train-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .train-empty {
            max-width: 400px;
        }

        .train-empty-icon {
            width: 88px;
            height: 88px;
            margin: 0 auto 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 50%;
            background: linear-gradient(135deg, var(--bg-elevated) 0%, var(--bg-dark) 100%);
        }

        .train-empty-icon svg {
            width: 36px;
            height: 36px;
            color: var(--gold);
            stroke-width: 1.5;
        }

        .train-empty h2 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: 0.02em;
            margin-bottom: 12px;
            color: var(--gold-light);
        }

        .train-empty p {
            color: var(--text-dim);
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 32px;
        }

        .btn-primary {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 32px;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
            border: none;
            border-radius: 50px;
            color: var(--bg-dark);
            font-family: var(--font-body);
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-primary svg {
            width: 18px;
            height: 18px;
            stroke-width: 2;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px var(--gold-glow);
        }

        /* Training Active */
        .train-active {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }

        .train-active.visible {
            display: flex;
        }

        .train-empty.hidden {
            display: none;
        }

        .train-image-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            min-height: 0;
        }

        .train-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--radius);
            border: 1px solid var(--border-subtle);
            transition: transform var(--transition), box-shadow var(--transition);
        }

        .train-image-wrap:hover .train-image {
            transform: scale(1.01);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .train-tap-hint {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .train-tap-hint svg {
            width: 14px;
            height: 14px;
            color: var(--gold);
        }

        .train-stats {
            display: flex;
            justify-content: center;
            gap: 48px;
            padding: 24px;
            margin-top: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
        }

        .train-stat {
            text-align: center;
        }

        .train-stat-value {
            font-family: var(--font-display);
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--gold);
        }

        .train-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 4px;
        }

        /* ========== GALLERY VIEW ========== */
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .gallery-header h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 500;
            color: var(--gold-light);
        }

        .gallery-count {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
        }

        .gallery-card {
            aspect-ratio: 1;
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 1px solid var(--border-subtle);
            transition: all var(--transition);
        }

        .gallery-card:hover {
            transform: translateY(-4px);
            border-color: var(--gold);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.4), 0 0 0 1px var(--gold-glow);
        }

        .gallery-card.selected {
            border-color: var(--gold);
            box-shadow: 0 0 0 2px var(--gold), 0 16px 48px rgba(0, 0, 0, 0.4);
        }

        .gallery-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-card-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, transparent 60%);
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            opacity: 0;
            transition: opacity var(--transition);
        }

        .gallery-card:hover .gallery-card-overlay,
        .gallery-card.selected .gallery-card-overlay {
            opacity: 1;
        }

        .gallery-card-best {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gold);
        }

        .gallery-card-sessions {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .gallery-card-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: 50%;
            color: var(--text-muted);
            cursor: pointer;
            opacity: 0;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-card-delete svg {
            width: 14px;
            height: 14px;
        }

        .gallery-card:hover .gallery-card-delete {
            opacity: 1;
        }

        .gallery-card-delete:hover {
            background: var(--danger);
            color: white;
        }

        .gallery-add {
            aspect-ratio: 1;
            border: 1px dashed var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all var(--transition);
            color: var(--text-muted);
        }

        .gallery-add:hover {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(212, 175, 55, 0.03);
        }

        .gallery-add svg {
            width: 28px;
            height: 28px;
            stroke-width: 1.5;
        }

        .gallery-add span {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* ========== STATS VIEW ========== */
        .stats-header {
            margin-bottom: 32px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .stats-header h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 500;
            color: var(--gold-light);
            margin-bottom: 4px;
        }

        .stats-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            transition: all var(--transition);
        }

        .stat-card:hover {
            border-color: var(--border);
        }

        .stat-card-value {
            font-family: var(--font-display);
            font-size: 2.2rem;
            font-weight: 600;
            color: var(--gold);
        }

        .stat-card-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 8px;
        }

        .history-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .history-header h3 {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--gold-light);
        }

        .history-filters {
            display: flex;
            gap: 8px;
        }

        .history-filters select {
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 0.8rem;
            font-family: var(--font-body);
        }

        .history-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-subtle);
            transition: background var(--transition);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: var(--bg-elevated);
        }

        .history-item-time {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gold);
            min-width: 80px;
        }

        .history-item-date {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .history-item-note {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-item-delete svg {
            width: 16px;
            height: 16px;
        }

        .history-item-delete:hover {
            color: var(--danger);
        }

        .history-empty {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }

        .history-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .history-pagination button {
            padding: 8px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all var(--transition);
        }

        .history-pagination button:hover:not(:disabled) {
            border-color: var(--gold);
            color: var(--gold);
        }

        .history-pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .history-pagination span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* ========== IMMERSIVE MODE ========== */
        .immersive {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .immersive.active {
            display: flex;
        }

        .immersive::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at center, transparent 0%, rgba(0, 0, 0, 0.6) 100%);
            pointer-events: none;
        }

        .immersive-image {
            max-width: 90%;
            max-height: 75%;
            object-fit: contain;
            border-radius: var(--radius);
            transition: opacity 0.5s ease;
            z-index: 1;
        }

        .immersive-timer {
            position: absolute;
            top: 32px;
            right: 32px;
            font-family: var(--font-display);
            font-size: 2.8rem;
            font-weight: 500;
            color: var(--gold);
            text-shadow: 0 0 40px var(--gold-glow);
            z-index: 2;
        }

        .immersive-hint {
            position: absolute;
            bottom: 40px;
            font-size: 0.85rem;
            color: var(--text-muted);
            background: rgba(20, 20, 20, 0.8);
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid var(--border-subtle);
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .immersive-hint kbd {
            padding: 4px 10px;
            background: var(--bg-elevated);
            border-radius: 4px;
            font-family: var(--font-body);
            color: var(--gold);
            font-size: 0.8rem;
        }

        .immersive-close {
            position: absolute;
            top: 32px;
            left: 32px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            color: var(--text-muted);
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .immersive-close svg {
            width: 20px;
            height: 20px;
        }

        .immersive-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: var(--text-muted);
        }

        /* ========== HELP MODAL ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-width: 480px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-header h2 {
            font-family: var(--font-display);
            font-size: 1.4rem;
            font-weight: 500;
            color: var(--gold-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header h2 svg {
            width: 22px;
            height: 22px;
            color: var(--gold);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .modal-close svg {
            width: 18px;
            height: 18px;
        }

        .modal-close:hover {
            color: white;
            border-color: var(--text-muted);
        }

        .modal-body {
            padding: 24px;
        }

        .help-section {
            margin-bottom: 28px;
        }

        .help-section:last-child {
            margin-bottom: 0;
        }

        .help-section h3 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 500;
            color: var(--gold);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .help-section h3 svg {
            width: 18px;
            height: 18px;
        }

        .help-list {
            list-style: none;
        }

        .help-list li {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .help-list li:last-child {
            border-bottom: none;
        }

        .help-list kbd {
            min-width: 48px;
            padding: 6px 10px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            text-align: center;
            font-family: var(--font-body);
            font-size: 0.8rem;
            color: var(--gold);
        }

        /* ========== MOBILE ========== */
        @media (max-width: 600px) {
            .view {
                padding: 20px;
            }

            .gallery-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .train-stats {
                gap: 24px;
                padding: 20px;
            }

            .stats-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .history-filters {
                width: 100%;
                flex-wrap: wrap;
            }

            .history-item {
                flex-wrap: wrap;
                gap: 8px;
            }

            .immersive-timer {
                font-size: 2rem;
                top: 20px;
                right: 20px;
            }

            .immersive-close {
                top: 20px;
                left: 20px;
                width: 40px;
                height: 40px;
            }

            .train-empty h2 {
                font-size: 1.6rem;
            }

            .gallery-header h1,
            .stats-header h1 {
                font-size: 1.6rem;
            }
        }

        #file-input {
            display: none;
        }
    </style>
</head>

<body>
    <input type="file" id="file-input" accept="image/*">

    <div class="app">
        <div class="views">
            <!-- Train View -->
            <div class="view train-view active" id="train-view">
                <div class="train-empty" id="train-empty">
                    <div class="train-empty-icon">
                        <i data-lucide="eye"></i>
                    </div>
                    <h2>Begin Your Practice</h2>
                    <p>Select an image from your collection to commence visualization training. Master the art of
                        holding images in your mind's eye.</p>
                    <button class="btn-primary" id="go-gallery-btn">
                        <i data-lucide="image"></i>
                        View Collection
                    </button>
                </div>

                <div class="train-active" id="train-active">
                    <div class="train-image-wrap" id="train-image-wrap">
                        <img class="train-image" id="train-image" src="" alt="Training image">
                        <div class="train-tap-hint">
                            <i data-lucide="maximize"></i>
                            Tap to enter focus mode
                        </div>
                    </div>
                    <div class="train-stats">
                        <div class="train-stat">
                            <div class="train-stat-value" id="train-best">0.00s</div>
                            <div class="train-stat-label">Personal Best</div>
                        </div>
                        <div class="train-stat">
                            <div class="train-stat-value" id="train-sessions">0</div>
                            <div class="train-stat-label">Sessions</div>
                        </div>
                        <div class="train-stat">
                            <div class="train-stat-value" id="train-total">0m</div>
                            <div class="train-stat-label">Total Time</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gallery View -->
            <div class="view" id="gallery-view">
                <div class="gallery-header">
                    <h1>Collection</h1>
                    <span class="gallery-count" id="gallery-count">0 images</span>
                </div>
                <div class="gallery-grid" id="gallery-grid"></div>
            </div>

            <!-- Stats View -->
            <div class="view" id="stats-view">
                <div class="stats-header">
                    <h1>Progress</h1>
                    <p>Your visualization journey at a glance</p>
                </div>

                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-total-sessions">0</div>
                        <div class="stat-card-label">Total Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-total-time">0m</div>
                        <div class="stat-card-label">Time Invested</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-best-ever">0.00s</div>
                        <div class="stat-card-label">Best Record</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-value" id="stat-images">0</div>
                        <div class="stat-card-label">In Collection</div>
                    </div>
                </div>

                <div class="history-section">
                    <div class="history-header">
                        <h3>Session History</h3>
                        <div class="history-filters">
                            <select id="filter-image">
                                <option value="">All Images</option>
                            </select>
                            <select id="filter-per-page">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                    </div>
                    <div class="history-list" id="history-list"></div>
                    <div class="history-pagination">
                        <button id="prev-page"><i data-lucide="chevron-left"></i></button>
                        <span id="page-info">Page 1 of 1</span>
                        <button id="next-page"><i data-lucide="chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" data-view="train-view">
                <i data-lucide="target"></i>
                <span>Train</span>
            </button>
            <button class="nav-btn" data-view="gallery-view">
                <i data-lucide="layout-grid"></i>
                <span>Collection</span>
            </button>
            <button class="nav-btn" data-view="stats-view">
                <i data-lucide="bar-chart-2"></i>
                <span>Progress</span>
            </button>
            <button class="nav-btn" id="help-nav-btn">
                <i data-lucide="book-open"></i>
                <span>Guide</span>
            </button>
        </nav>
    </div>

    <!-- Immersive Mode -->
    <div class="immersive" id="immersive">
        <button class="immersive-close" id="immersive-close">
            <i data-lucide="x"></i>
        </button>
        <div class="immersive-timer" id="immersive-timer">0.00s</div>
        <img class="immersive-image" id="immersive-image" src="" alt="Focus image">
        <div class="immersive-hint">
            Hold <kbd>Space</kbd> to visualize
            <span>·</span>
            <kbd>Esc</kbd> to exit
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal">
            <div class="modal-header">
                <h2><i data-lucide="book-open"></i> Practitioner's Guide</h2>
                <button class="modal-close" id="help-close">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3><i data-lucide="target"></i> The Practice</h3>
                    <ul class="help-list">
                        <li>Add images to your collection</li>
                        <li>Select an image and enter focus mode</li>
                        <li>Study the image, then hold to hide it</li>
                        <li>Visualize in your mind as long as possible</li>
                        <li>Release to record your time</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3><i data-lucide="keyboard"></i> Controls</h3>
                    <ul class="help-list">
                        <li><kbd>Space</kbd> Hold to visualize</li>
                        <li><kbd>Esc</kbd> Exit focus mode</li>
                        <li><kbd>1-4</kbd> Switch sections</li>
                        <li><kbd>?</kbd> Toggle this guide</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3><i data-lucide="sparkles"></i> Advice</h3>
                    <ul class="help-list">
                        <li>Begin with simple images</li>
                        <li>Practice with consistency</li>
                        <li>Challenge your personal records</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ========== DOM ==========
        const $ = id => document.getElementById(id);
        const $$ = sel => document.querySelectorAll(sel);

        const fileInput = $('file-input');
        const views = $$('.view');
        const navBtns = $$('.nav-btn[data-view]');
        const helpNavBtn = $('help-nav-btn');
        const trainEmpty = $('train-empty');
        const trainActive = $('train-active');
        const trainImage = $('train-image');
        const trainImageWrap = $('train-image-wrap');
        const trainBest = $('train-best');
        const trainSessions = $('train-sessions');
        const trainTotal = $('train-total');
        const goGalleryBtn = $('go-gallery-btn');
        const galleryGrid = $('gallery-grid');
        const galleryCount = $('gallery-count');
        const statTotalSessions = $('stat-total-sessions');
        const statTotalTime = $('stat-total-time');
        const statBestEver = $('stat-best-ever');
        const statImages = $('stat-images');
        const filterImage = $('filter-image');
        const filterPerPage = $('filter-per-page');
        const historyList = $('history-list');
        const pageInfo = $('page-info');
        const prevPage = $('prev-page');
        const nextPage = $('next-page');
        const immersive = $('immersive');
        const immersiveImage = $('immersive-image');
        const immersiveTimer = $('immersive-timer');
        const immersiveClose = $('immersive-close');
        const helpModal = $('help-modal');
        const helpClose = $('help-close');

        // ========== STATE ==========
        let images = [];
        let selectedImageId = null;
        let isImmersive = false;
        let isVisualizing = false;
        let timerInterval = null;
        let seconds = 0;
        let historyPage = 1;
        let historyPerPage = 10;
        let historyImageFilter = '';

        // ========== STORAGE ==========
        const save = () => localStorage.setItem('visutrain_data', JSON.stringify(images));

        const load = () => {
            try {
                const data = localStorage.getItem('visualizationTrainerData') || localStorage.getItem('visutrain_data');
                if (data) {
                    images = JSON.parse(data).map(img => ({
                        ...img,
                        sessions: (img.sessions || []).map(s =>
                            typeof s === 'number'
                                ? { time: s, date: new Date().toISOString(), note: '' }
                                : { time: s.time || 0, date: s.date || new Date().toISOString(), note: s.note || '' }
                        )
                    }));
                }
            } catch (e) {
                images = [];
            }
        };

        // ========== NAVIGATION ==========
        function switchView(viewId) {
            views.forEach(v => v.classList.remove('active'));
            $(viewId).classList.add('active');
            navBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewId));

            if (viewId === 'gallery-view') renderGallery();
            if (viewId === 'stats-view') renderStats();
            if (viewId === 'train-view') renderTrain();
        }

        navBtns.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
        goGalleryBtn.addEventListener('click', () => switchView('gallery-view'));

        // ========== GALLERY ==========
        function renderGallery() {
            galleryGrid.innerHTML = '';

            const addCard = document.createElement('div');
            addCard.className = 'gallery-add';
            addCard.innerHTML = '<i data-lucide="plus"></i><span>Add Image</span>';
            addCard.addEventListener('click', () => fileInput.click());
            galleryGrid.appendChild(addCard);

            images.forEach(img => {
                const card = document.createElement('div');
                card.className = 'gallery-card' + (img.id === selectedImageId ? ' selected' : '');
                card.innerHTML = `
                    <img src="${img.src}" alt="Gallery image">
                    <div class="gallery-card-overlay">
                        <div class="gallery-card-best">${(img.highScore || 0).toFixed(2)}s</div>
                        <div class="gallery-card-sessions">${(img.sessions || []).length} sessions</div>
                    </div>
                    <button class="gallery-card-delete"><i data-lucide="trash-2"></i></button>
                `;

                card.addEventListener('click', e => {
                    if (e.target.closest('.gallery-card-delete')) {
                        e.stopPropagation();
                        if (confirm('Remove this image from your collection?')) {
                            images = images.filter(i => i.id !== img.id);
                            if (selectedImageId === img.id) selectedImageId = null;
                            save();
                            renderGallery();
                            renderTrain();
                        }
                        return;
                    }
                    selectedImageId = img.id;
                    save();
                    renderGallery();
                    switchView('train-view');
                });

                galleryGrid.appendChild(card);
            });

            galleryCount.textContent = `${images.length} image${images.length !== 1 ? 's' : ''}`;
            lucide.createIcons();
        }

        // ========== FILE UPLOAD ==========
        fileInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = ev => {
                const newImg = {
                    id: `img_${Date.now()}`,
                    src: ev.target.result,
                    sessions: [],
                    highScore: 0
                };
                images.push(newImg);
                selectedImageId = newImg.id;
                save();
                renderGallery();
                switchView('train-view');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });

        // ========== TRAIN VIEW ==========
        function renderTrain() {
            const img = images.find(i => i.id === selectedImageId);

            if (!img) {
                trainEmpty.classList.remove('hidden');
                trainActive.classList.remove('visible');
                return;
            }

            trainEmpty.classList.add('hidden');
            trainActive.classList.add('visible');
            trainImage.src = img.src;
            immersiveImage.src = img.src;

            trainBest.textContent = `${(img.highScore || 0).toFixed(2)}s`;
            trainSessions.textContent = (img.sessions || []).length;

            const totalSec = (img.sessions || []).reduce((sum, s) => sum + s.time, 0);
            trainTotal.textContent = formatTime(totalSec);
        }

        function formatTime(sec) {
            if (sec < 60) return `${sec.toFixed(0)}s`;
            if (sec < 3600) return `${(sec / 60).toFixed(1)}m`;
            return `${(sec / 3600).toFixed(1)}h`;
        }

        trainImageWrap.addEventListener('click', () => {
            if (selectedImageId) enterImmersive();
        });

        // ========== IMMERSIVE MODE ==========
        async function enterImmersive() {
            isImmersive = true;
            immersive.classList.add('active');
            immersiveImage.style.opacity = '1';
            immersiveTimer.textContent = '0.00s';

            try {
                if (immersive.requestFullscreen) {
                    await immersive.requestFullscreen();
                } else if (immersive.webkitRequestFullscreen) {
                    await immersive.webkitRequestFullscreen();
                }
            } catch (e) { }
        }

        async function exitImmersive() {
            if (isVisualizing) stopVisualize();
            isImmersive = false;
            immersive.classList.remove('active');

            try {
                if (document.fullscreenElement) {
                    await document.exitFullscreen();
                } else if (document.webkitFullscreenElement) {
                    await document.webkitExitFullscreen();
                }
            } catch (e) { }
        }

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isImmersive) {
                isImmersive = false;
                immersive.classList.remove('active');
                if (isVisualizing) stopVisualize();
            }
        });

        immersiveClose.addEventListener('click', exitImmersive);

        immersive.addEventListener('click', e => {
            if (e.target === immersive && !isVisualizing) exitImmersive();
        });

        // ========== VISUALIZATION ==========
        function startVisualize() {
            if (!selectedImageId || isVisualizing) return;

            isVisualizing = true;
            seconds = 0;
            const start = Date.now();

            immersiveImage.style.opacity = '0';

            timerInterval = setInterval(() => {
                seconds = (Date.now() - start) / 1000;
                immersiveTimer.textContent = `${seconds.toFixed(2)}s`;
            }, 16);
        }

        function stopVisualize() {
            if (!timerInterval) return;

            clearInterval(timerInterval);
            timerInterval = null;
            isVisualizing = false;

            immersiveImage.style.opacity = '1';

            if (seconds > 0.2) {
                const img = images.find(i => i.id === selectedImageId);
                if (img) {
                    img.sessions.unshift({
                        time: seconds,
                        date: new Date().toISOString(),
                        note: ''
                    });
                    if (seconds > img.highScore) img.highScore = seconds;
                    save();
                    renderTrain();
                }
            }
        }

        let touchStarted = false;

        immersive.addEventListener('mousedown', e => {
            if (e.target !== immersiveClose && !e.target.closest('.immersive-close') && isImmersive) startVisualize();
        });
        immersive.addEventListener('mouseup', () => { if (isVisualizing) stopVisualize(); });

        immersive.addEventListener('touchstart', e => {
            if (e.target !== immersiveClose && !e.target.closest('.immersive-close') && isImmersive) {
                touchStarted = true;
                startVisualize();
            }
        }, { passive: true });
        immersive.addEventListener('touchend', () => {
            if (touchStarted && isVisualizing) stopVisualize();
            touchStarted = false;
        });

        // ========== STATS VIEW ==========
        function renderStats() {
            let totalSessions = 0, totalTime = 0, bestEver = 0;

            images.forEach(img => {
                (img.sessions || []).forEach(s => {
                    totalSessions++;
                    totalTime += s.time;
                    if (s.time > bestEver) bestEver = s.time;
                });
            });

            statTotalSessions.textContent = totalSessions;
            statTotalTime.textContent = formatTime(totalTime);
            statBestEver.textContent = `${bestEver.toFixed(2)}s`;
            statImages.textContent = images.length;

            filterImage.innerHTML = '<option value="">All Images</option>';
            images.forEach((img, i) => {
                filterImage.innerHTML += `<option value="${img.id}">Image ${i + 1}</option>`;
            });
            filterImage.value = historyImageFilter;

            renderHistory();
        }

        function renderHistory() {
            let allSessions = [];

            images.forEach(img => {
                if (historyImageFilter && img.id !== historyImageFilter) return;
                (img.sessions || []).forEach(s => {
                    allSessions.push({ ...s, imageId: img.id });
                });
            });

            allSessions.sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalPages = Math.ceil(allSessions.length / historyPerPage) || 1;
            historyPage = Math.max(1, Math.min(historyPage, totalPages));

            const start = (historyPage - 1) * historyPerPage;
            const paginated = allSessions.slice(start, start + historyPerPage);

            if (paginated.length === 0) {
                historyList.innerHTML = '<div class="history-empty">No sessions recorded yet</div>';
            } else {
                historyList.innerHTML = paginated.map(s => `
                    <div class="history-item" data-date="${s.date}" data-image="${s.imageId}">
                        <span class="history-item-time">${s.time.toFixed(2)}s</span>
                        <span class="history-item-date">${new Date(s.date).toLocaleString()}</span>
                        <span class="history-item-note">${s.note || '—'}</span>
                        <button class="history-item-delete"><i data-lucide="x"></i></button>
                    </div>
                `).join('');
            }

            pageInfo.textContent = `Page ${historyPage} of ${totalPages}`;
            prevPage.disabled = historyPage <= 1;
            nextPage.disabled = historyPage >= totalPages;

            lucide.createIcons();
        }

        historyList.addEventListener('click', e => {
            if (e.target.closest('.history-item-delete')) {
                const item = e.target.closest('.history-item');
                const date = item.dataset.date;
                const imageId = item.dataset.image;

                const img = images.find(i => i.id === imageId);
                if (img) {
                    img.sessions = img.sessions.filter(s => s.date !== date);
                    img.highScore = Math.max(0, ...img.sessions.map(s => s.time), 0);
                    save();
                    renderStats();
                    renderTrain();
                }
            }
        });

        filterImage.addEventListener('change', () => {
            historyImageFilter = filterImage.value;
            historyPage = 1;
            renderHistory();
        });

        filterPerPage.addEventListener('change', () => {
            historyPerPage = parseInt(filterPerPage.value);
            historyPage = 1;
            renderHistory();
        });

        prevPage.addEventListener('click', () => { if (historyPage > 1) { historyPage--; renderHistory(); } });
        nextPage.addEventListener('click', () => { historyPage++; renderHistory(); });

        // ========== HELP ==========
        function toggleHelp(show) { helpModal.classList.toggle('active', show); }

        helpNavBtn.addEventListener('click', () => toggleHelp(true));
        helpClose.addEventListener('click', () => toggleHelp(false));
        helpModal.addEventListener('click', e => { if (e.target === helpModal) toggleHelp(false); });

        // ========== KEYBOARD ==========
        document.addEventListener('keydown', e => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    if (isImmersive && !isVisualizing) startVisualize();
                    else if (selectedImageId && !isImmersive) enterImmersive();
                    break;
                case 'Escape':
                    if (helpModal.classList.contains('active')) toggleHelp(false);
                    else if (isImmersive) exitImmersive();
                    break;
                case '1': switchView('train-view'); break;
                case '2': switchView('gallery-view'); break;
                case '3': switchView('stats-view'); break;
                case '4':
                case '?': toggleHelp(!helpModal.classList.contains('active')); break;
            }
        });

        document.addEventListener('keyup', e => {
            if (e.key === ' ' && isVisualizing) stopVisualize();
        });

        // ========== INIT ==========
        load();
        if (images.length > 0 && !selectedImageId) selectedImageId = images[0].id;
        renderTrain();
        renderGallery();
    </script>
</body>

</html>